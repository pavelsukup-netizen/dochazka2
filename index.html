<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MERCHANDISER LOG</title>

  <!-- PWA (pokud pou≈æ√≠v√°≈° manifest.webmanifest, nech takhle; jinak zmƒõ≈à na manifest.json) -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#4f46e5" />

  <!-- Supabase JS (CDN, bez bundleru) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#eef2f7;
      --card:#ffffff;
      --shadow:0 18px 40px rgba(15, 23, 42, .14);
      --text:#0f172a;
      --muted:#64748b;

      --brand:#4f46e5;
      --brandDark:#4338ca;

      --green:#16a34a;
      --greenDark:#15803d;

      --red:#ef4444;
      --redDark:#dc2626;

      --blue:#60a5fa;      /* vstup prodejna */
      --blueDark:#3b82f6;

      --yellow:#fbbf24;    /* odchod prodejna */
      --yellowDark:#f59e0b;

      --gray:#9ca3af;
      --grayDark:#6b7280;

      --navy:#111827;
      --navyDark:#0b1220;

      --line:#e5e7eb;
      --radius:18px;
    }

    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      display:flex;
      justify-content:center;
      padding:24px 14px;
    }
    .phone{ width:min(430px, 100%); }
    .card{
      background: var(--card);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.06);
    }

    .header{
      position: relative;
      background: var(--brand);
      padding: 22px 18px 18px;
      text-align:center;
      color:#fff;
    }
    .title{
      font-weight: 900;
      letter-spacing: .5px;
      font-size: 22px;
      margin:0 0 8px;
    }
    .now{ margin:0; opacity:.95; font-weight: 700; font-size: 14px; }
    .pill{
      display:inline-block;
      margin-top: 12px;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(15,23,42,.35);
      border: 1px solid rgba(255,255,255,.25);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .25px;
      text-transform: uppercase;
    }

    /* hamburger */
    .hamb{
      position:absolute;
      right: 14px;
      top: 14px;
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(15,23,42,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    .hamb:active{ transform: scale(.99); }
    .hambLines{
      width: 18px; height: 12px; position:relative;
    }
    .hambLines span{
      position:absolute; left:0; right:0;
      height:2px; border-radius:2px;
      background:#fff;
      opacity:.95;
    }
    .hambLines span:nth-child(1){ top:0; }
    .hambLines span:nth-child(2){ top:5px; }
    .hambLines span:nth-child(3){ top:10px; }

    .content{ padding: 16px 18px 18px; }
    .sectionTitle{
      font-size: 12px;
      font-weight: 900;
      color: #7c8697;
      letter-spacing: 1px;
      margin: 10px 2px 10px;
      text-transform: uppercase;
    }
    .row{ display:flex; gap: 14px; }

    .btn{
      border:0;
      border-radius: 12px;
      padding: 14px 12px;
      font-weight: 900;
      font-size: 15px;
      width:100%;
      color:#fff;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(2,6,23,.10);
      transition: transform .05s ease, filter .12s ease, opacity .12s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; box-shadow:none; }

    .green{ background: var(--green); }
    .green:active{ background: var(--greenDark); }

    .red{ background: var(--red); }
    .red:active{ background: var(--redDark); }

    .blue{ background: var(--blue); color:#0b1220; }
    .blue:active{ background: var(--blueDark); color:#fff; }

    .yellow{ background: var(--yellow); color:#0b1220; }
    .yellow:active{ background: var(--yellowDark); color:#fff; }

    .gray{ background: var(--gray); }
    .gray:active{ background: var(--grayDark); }

    .navy{ background: var(--navy); }
    .navy:active{ background: var(--navyDark); }

    .divider{
      height:1px;
      background: var(--line);
      margin: 14px 0;
    }

    .fieldRow{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-top: 6px;
    }

    .input{
      width:100%;
      border-radius: 12px;
      border: 1px solid #d8dee9;
      padding: 12px 12px;
      font-size: 14px;
      outline:none;
      background:#fff;
    }
    .input:focus{
      border-color: rgba(79,70,229,.45);
      box-shadow: 0 0 0 3px rgba(79,70,229,.15);
    }

    .status{
      padding: 10px 12px;
      background: #f8fafc;
      border: 1px solid #e7edf6;
      border-radius: 14px;
      font-size: 12px;
      color: #334155;
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid #e7edf6;
      background:#fff;
      font-size: 12px;
      font-weight: 900;
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background:#94a3b8; }
    .dot.ok{ background:#22c55e; }
    .dot.warn{ background:#f59e0b; }
    .dot.bad{ background:#ef4444; }

    .activity{ margin-top: 10px; padding-bottom: 6px; }

    .item{
      border: 1px solid #e7edf6;
      background: #fbfdff;
      border-radius: 14px;
      padding: 10px 12px;
      margin-top: 8px;
    }

    .itemTop{
      display:flex;
      justify-content:space-between;
      gap: 12px;
      align-items:flex-start;
    }

    .tag{
      font-weight: 900;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(79,70,229,.10);
      color: var(--brandDark);
      white-space:nowrap;
    }

    .itemTitle{
      font-weight: 900;
      font-size: 14px;
      margin:0;
    }

    .itemSub{
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      white-space: pre-wrap;
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .tiny{ font-size: 11px; color: var(--muted); font-weight: 900; }

    .exportBar{
      display:flex;
      gap: 10px;
      align-items:center;
      margin-top: 8px;
    }

    .month{
      width: 150px;
      min-width: 150px;
      border-radius: 12px;
      border: 1px solid #d8dee9;
      padding: 12px 10px;
      font-weight: 900;
      font-size: 13px;
      background:#fff;
      color: var(--text);
      outline:none;
    }

    /* CONFIRM MODAL */
    .modalBack{
      position: fixed; inset:0;
      background: rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    #modalBack{ z-index: 10000; }    /* confirm = TOP */
    #formBack{ z-index: 9000; }      /* form = middle */

    .modal{
      width: min(420px, 100%);
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 30px 70px rgba(0,0,0,.22);
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.08);
    }
    .modalHead{
      padding: 14px 14px 10px;
      background: #f8fafc;
      border-bottom: 1px solid #e7edf6;
      font-weight: 1000;
    }
    .modalBody{ padding: 14px; }
    .modalMsg{
      margin:0;
      font-size: 14px;
      font-weight: 900;
      color:#0f172a;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .modalActions{
      display:flex;
      gap: 10px;
      padding: 14px;
      border-top: 1px solid #e7edf6;
      background: #fff;
    }

    /* DRAWER */
    .drawerBack{
      position: fixed; inset:0;
      background: rgba(15,23,42,.40);
      display:none;
      z-index: 8000; /* drawer = bottom overlay */
    }
    .drawer{
      position:absolute;
      right: 0;
      top: 0;
      height: 100%;
      width: min(360px, 92vw);
      background: #fff;
      box-shadow: -18px 0 40px rgba(0,0,0,.18);
      border-left: 1px solid rgba(15,23,42,.08);
      display:flex;
      flex-direction: column;
    }
    .drawerHead{
      padding: 14px;
      border-bottom: 1px solid #e7edf6;
      display:flex;
      align-items:center;
      justify-content: space-between;
      font-weight: 1000;
    }
    .drawerClose{
      width: 40px; height: 40px;
      border-radius: 12px;
      border:1px solid #e7edf6;
      background:#f8fafc;
      cursor:pointer;
      font-weight: 1000;
    }
    .drawerBody{
      padding: 14px;
      overflow:auto;
    }
    .drawerGroupTitle{
      font-size: 12px;
      font-weight: 1000;
      color:#64748b;
      letter-spacing: .9px;
      text-transform: uppercase;
      margin: 10px 2px 10px;
    }
    .drawerBtn{
      width:100%;
      border-radius: 14px;
      border:1px solid #e7edf6;
      background:#fff;
      padding: 12px 12px;
      font-weight: 1000;
      cursor:pointer;
      text-align:left;
      display:flex;
      justify-content: space-between;
      align-items:center;
      margin-bottom: 10px;
    }
    .drawerBtn:active{ transform: scale(.99); }
    .chip{
      font-size: 12px;
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
      background:#f1f5f9;
      color:#334155;
      border:1px solid #e7edf6;
      white-space:nowrap;
    }

    /* FORM MODAL */
    .formRow{ margin-top: 10px; }
    .label{
      display:block;
      font-size: 12px;
      font-weight: 1000;
      color:#64748b;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .8px;
    }

    /* LOGIN OVERLAY */
    .loginBack{
      position: fixed; inset:0;
      background: rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 11000;
    }
    .loginCard{
      width: min(420px, 100%);
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 30px 70px rgba(0,0,0,.22);
      overflow:hidden;
      border: 1px solid rgba(15,23,42,.08);
    }
    .loginHead{
      padding: 14px 14px 10px;
      background: #f8fafc;
      border-bottom: 1px solid #e7edf6;
      font-weight: 1000;
    }
    .loginBody{ padding: 14px; }
    .loginActions{
      display:flex;
      gap: 10px;
      padding: 14px;
      border-top: 1px solid #e7edf6;
      background:#fff;
    }
  </style>
</head>

<body>
  <div class="phone">
    <div class="card">
      <div class="header">
        <div class="hamb" id="btnHamb" title="Menu">
          <div class="hambLines"><span></span><span></span><span></span></div>
        </div>

        <h1 class="title">MERCHANDISER LOG</h1>
        <p class="now mono" id="nowText">--</p>
        <div class="pill" id="modePill">MIMO PRACOVN√ç DOBU</div>
      </div>

      <div class="content">
        <div class="sectionTitle">PRACOVN√ç SMƒöNA</div>
        <div class="row">
          <button class="btn green" id="btnShiftStart">P≈ò√çCHOD</button>
          <button class="btn red" id="btnShiftEnd">ODCHOD</button>
        </div>

        <div class="divider"></div>

        <div class="sectionTitle">N√ÅV≈†TƒöVA PRODEJNY</div>
        <div class="fieldRow">
          <input class="input" id="storeName" placeholder="N√°zev prodejny (nap≈ô. Albert Andƒõl)" />
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <button class="btn blue" id="btnStoreIn">VSTUP NA<br/>PRODEJNU</button>
          <button class="btn yellow" id="btnStoreOut">ODCHOD Z<br/>PRODEJNY</button>
        </div>

        <div class="divider"></div>

        <div class="exportBar">
          <button class="btn navy" id="btnExport">‚¨á St√°hnout p≈ôehled (CSV)</button>
          <input class="month" id="monthPick" type="month" />
        </div>

        <div style="height:10px"></div>
        <div class="status" id="status">
          <span id="statusText">Stav: p≈ôipraveno.</span>
          <span class="badge" id="syncBadge"><span class="dot" id="syncDot"></span><span id="syncText">offline</span></span>
        </div>

        <div class="divider"></div>

        <div class="sectionTitle">DNE≈†N√ç AKTIVITA</div>
        <div class="activity" id="activity"></div>

        <div class="tiny">
          Data se ukl√°daj√≠ online na Supabase (po p≈ôihl√°≈°en√≠). Kdy≈æ nen√≠ sign√°l, ukl√°d√° se do fronty a ode≈°le se pozdƒõji.
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm modal -->
  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead" id="modalTitle">Potvrzen√≠</div>
      <div class="modalBody">
        <p class="modalMsg" id="modalMsg">--</p>
      </div>
      <div class="modalActions">
        <button class="btn green" id="modalYes">ANO</button>
        <button class="btn red" id="modalNo">NE</button>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div class="drawerBack" id="drawerBack" aria-hidden="true">
    <div class="drawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle">
      <div class="drawerHead">
        <div id="drawerTitle">MENU</div>
        <button class="drawerClose" id="drawerClose">‚úï</button>
      </div>
      <div class="drawerBody">
        <div class="drawerGroupTitle">Doch√°zka</div>

        <button class="drawerBtn" id="btnTraining">
          <span>≈†kolen√≠ (placen√©)</span>
          <span class="chip">od‚Äìdo</span>
        </button>

        <button class="drawerBtn" id="btnSick">
          <span>Nemoc (neplacen√°)</span>
          <span class="chip">od‚Äìdo</span>
        </button>

        <button class="drawerBtn" id="btnVacation">
          <span>Dovolen√°</span>
          <span class="chip">dny</span>
        </button>

        <div class="drawerGroupTitle">√öƒçet</div>
        <button class="drawerBtn" id="btnAccount">
          <span id="accountLabel">Nep≈ôihl√°≈°en</span>
          <span class="chip" id="accountChip">login</span>
        </button>

        <div class="drawerGroupTitle">Servis</div>
        <button class="drawerBtn" id="btnSyncNow">
          <span>Odeslat ƒçekaj√≠c√≠ z√°znamy</span>
          <span class="chip">sync</span>
        </button>

        <button class="drawerBtn" id="btnClearToday">
          <span>Vymazat dne≈°n√≠ lok√°ln√≠ cache</span>
          <span class="chip">bez cloudu</span>
        </button>

        <button class="drawerBtn" id="btnClearAllLocal">
          <span>Vymazat ve≈°ker√° lok√°ln√≠ data</span>
          <span class="chip">bez cloudu</span>
        </button>

        <div class="tiny">Tip: pokud nƒõco zlob√≠ po update, sma≈æ data webu (Chrome ‚Üí üîí ‚Üí √ölo≈æi≈°tƒõ ‚Üí Vymazat data).</div>
      </div>
    </div>
  </div>

  <!-- Form modal -->
  <div class="modalBack" id="formBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="formTitle">
      <div class="modalHead" id="formTitle">Formul√°≈ô</div>
      <div class="modalBody" id="formBody"></div>
      <div class="modalActions" id="formActions"></div>
    </div>
  </div>

  <!-- Login overlay -->
  <div class="loginBack" id="loginBack" aria-hidden="true">
    <div class="loginCard" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <div class="loginHead" id="loginTitle">P≈ôihl√°≈°en√≠</div>
      <div class="loginBody">
        <div class="tiny" style="margin-bottom:10px">P≈ôihl√°≈°en√≠ je pot≈ôeba, aby se doch√°zka ukl√°dala online.</div>

        <div class="formRow">
          <label class="label" for="loginEmail">Email</label>
          <input class="input" id="loginEmail" type="email" placeholder="name@company.cz" />
        </div>

        <div class="formRow">
          <label class="label" for="loginPass">Heslo</label>
          <input class="input" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div class="tiny" id="loginMsg" style="margin-top:10px;color:#ef4444;display:none;"></div>
      </div>
      <div class="loginActions">
        <button class="btn green" id="btnLogin">P≈ôihl√°sit</button>
        <button class="btn gray" id="btnLoginLater">Pozdƒõji</button>
      </div>
    </div>
  </div>

<script>
(() => {
  /******************************************************************
   * 0) SUPABASE KONFIGURACE ‚Äì VYPL≈á!
   ******************************************************************/
  const SUPABASE_URL = "https://rzjgpjhtqzoafzndeqox.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable-_8Ua7QrR_HT2jsRKIJwBSA_CNM1i5c0";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /******************************************************************
   * 1) DOM
   ******************************************************************/
  const elNow = document.getElementById("nowText");
  const elPill = document.getElementById("modePill");

  const elStatusText = document.getElementById("statusText");
  const elSyncBadge = document.getElementById("syncBadge");
  const elSyncDot = document.getElementById("syncDot");
  const elSyncText = document.getElementById("syncText");

  const elActivity = document.getElementById("activity");

  const btnShiftStart = document.getElementById("btnShiftStart");
  const btnShiftEnd = document.getElementById("btnShiftEnd");
  const btnStoreIn = document.getElementById("btnStoreIn");
  const btnStoreOut = document.getElementById("btnStoreOut");
  const btnExport = document.getElementById("btnExport");
  const inpStore = document.getElementById("storeName");
  const monthPick = document.getElementById("monthPick");

  // confirm modal
  const modalBack = document.getElementById("modalBack");
  const modalMsg = document.getElementById("modalMsg");
  const modalYes = document.getElementById("modalYes");
  const modalNo = document.getElementById("modalNo");

  // drawer
  const btnHamb = document.getElementById("btnHamb");
  const drawerBack = document.getElementById("drawerBack");
  const drawerClose = document.getElementById("drawerClose");
  const btnTraining = document.getElementById("btnTraining");
  const btnSick = document.getElementById("btnSick");
  const btnVacation = document.getElementById("btnVacation");
  const btnAccount = document.getElementById("btnAccount");
  const accountLabel = document.getElementById("accountLabel");
  const accountChip = document.getElementById("accountChip");
  const btnSyncNow = document.getElementById("btnSyncNow");
  const btnClearToday = document.getElementById("btnClearToday");
  const btnClearAllLocal = document.getElementById("btnClearAllLocal");

  // form modal
  const formBack = document.getElementById("formBack");
  const formTitle = document.getElementById("formTitle");
  const formBody = document.getElementById("formBody");
  const formActions = document.getElementById("formActions");

  // login overlay
  const loginBack = document.getElementById("loginBack");
  const loginEmail = document.getElementById("loginEmail");
  const loginPass = document.getElementById("loginPass");
  const loginMsg = document.getElementById("loginMsg");
  const btnLogin = document.getElementById("btnLogin");
  const btnLoginLater = document.getElementById("btnLoginLater");

  /******************************************************************
   * 2) HELPERS
   ******************************************************************/
  const pad2 = (n) => String(n).padStart(2, "0");

  function fmtDate(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function fmtTime(ts){
    const d = new Date(ts);
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  function fmtDateTime(ts){ return `${fmtDate(ts)} ${fmtTime(ts)}`; }

  function todayKey(){ return fmtDate(Date.now()); }

  function minutesDiff(aTs, bTs){
    if(aTs == null || bTs == null) return null;
    if(bTs < aTs) return null;
    return Math.floor((bTs - aTs) / 60000);
  }
  function hm(min){
    if(min == null) return "";
    const h = Math.floor(min/60);
    const m = min%60;
    return `${h} h ${pad2(m)} m`;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  function dtLocalValue(ts){
    const d = new Date(ts);
    const yyyy = d.getFullYear();
    const mm = pad2(d.getMonth()+1);
    const dd = pad2(d.getDate());
    const hh = pad2(d.getHours());
    const mi = pad2(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }

  function monthKeyDefault(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  }

  function setStatus(msg){
    elStatusText.textContent = "Stav: " + msg;
  }

  function setSyncBadge({state, text}){
    // state: ok | warn | bad
    elSyncDot.classList.remove("ok","warn","bad");
    if(state === "ok") elSyncDot.classList.add("ok");
    if(state === "warn") elSyncDot.classList.add("warn");
    if(state === "bad") elSyncDot.classList.add("bad");
    elSyncText.textContent = text;
  }

  function lockUI(lock){
    btnShiftStart.disabled = lock;
    btnShiftEnd.disabled = lock;
    btnStoreIn.disabled = lock;
    btnStoreOut.disabled = lock;
    btnExport.disabled = lock;
    inpStore.disabled = lock;
    monthPick.disabled = lock;
  }

  /******************************************************************
   * 3) MODALS / DRAWER
   ******************************************************************/
  function confirmAction(message){
    return new Promise((resolve) => {
      modalMsg.textContent = message;
      modalBack.style.display = "flex";
      modalBack.setAttribute("aria-hidden","false");
      modalBack.style.zIndex = "10000"; // v≈ædy navrch

      const cleanup = () => {
        modalBack.style.display = "none";
        modalBack.setAttribute("aria-hidden","true");
        modalBack.style.zIndex = "";
        modalYes.onclick = null;
        modalNo.onclick = null;
        modalBack.onclick = null;
      };

      modalYes.onclick = () => { cleanup(); resolve(true); };
      modalNo.onclick  = () => { cleanup(); resolve(false); };
      modalBack.onclick = (e) => { if(e.target === modalBack){ cleanup(); resolve(false); } };
    });
  }

  function openDrawer(){
    drawerBack.style.display = "block";
    drawerBack.setAttribute("aria-hidden","false");
  }
  function closeDrawer(){
    drawerBack.style.display = "none";
    drawerBack.setAttribute("aria-hidden","true");
  }

  function openForm({title, bodyHtml, buttons}){
    formTitle.textContent = title;
    formBody.innerHTML = bodyHtml;
    formActions.innerHTML = "";

    buttons.forEach(b => {
      const btn = document.createElement("button");
      btn.className = b.cls || "btn gray";
      btn.textContent = b.text;
      btn.onclick = async () => { await b.onClick?.(); };
      formActions.appendChild(btn);
    });

    formBack.style.display = "flex";
    formBack.setAttribute("aria-hidden","false");

    formBack.onclick = (e) => { if(e.target === formBack) closeForm(); };
  }
  function closeForm(){
    formBack.style.display = "none";
    formBack.setAttribute("aria-hidden","true");
    formBack.onclick = null;
  }
  function $id(id){ return document.getElementById(id); }

  function showLoginOverlay(show){
    loginBack.style.display = show ? "flex" : "none";
    loginBack.setAttribute("aria-hidden", show ? "false" : "true");
    loginMsg.style.display = "none";
    loginMsg.textContent = "";
  }

  /******************************************************************
   * 4) GEO
   ******************************************************************/
  function getGeo(){
    return new Promise((resolve) => {
      if(!navigator.geolocation){
        resolve({ ok:false, err:"Geolocation nen√≠ podporovan√Ω." });
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({
          ok:true,
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          acc: pos.coords.accuracy
        }),
        (err) => resolve({ ok:false, err: err?.message || "GPS chyba" }),
        { enableHighAccuracy:true, timeout: 12000, maximumAge: 0 }
      );
    });
  }

  async function capturePoint(){
    const ts = Date.now();
    const geo = await getGeo();
    return {
      ts,
      lat: geo.ok ? geo.lat : null,
      lon: geo.ok ? geo.lon : null,
      acc: geo.ok ? geo.acc : null,
      geoOk: geo.ok,
      geoErr: geo.ok ? null : geo.err
    };
  }

  function gpsText(p){
    const has = (p?.lat != null && p?.lon != null);
    if(!has) return "bez GPS";
    const acc = (p.acc != null) ? `¬±${Math.round(p.acc)}m` : "¬±?";
    return `${p.lat.toFixed(6)}, ${p.lon.toFixed(6)} (${acc})`;
  }

  /******************************************************************
   * 5) AUTH (Supabase)
   ******************************************************************/
  async function signIn(email, password){
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) throw error;
    return data;
  }

  async function signOut(){
    const { error } = await supabase.auth.signOut();
    if(error) throw error;
  }

  async function getUser(){
    const { data } = await supabase.auth.getUser();
    return data?.user || null;
  }

  async function ensureAuthUI(){
    const user = await getUser();
    if(user){
      accountLabel.textContent = user.email || "P≈ôihl√°≈°en";
      accountChip.textContent = "logout";
      showLoginOverlay(false);
    }else{
      accountLabel.textContent = "Nep≈ôihl√°≈°en";
      accountChip.textContent = "login";
      // login overlay uk√°≈æeme jen pokud chce≈° striktn√≠ re≈æim ‚Äì nech√°v√°m ‚Äûmƒõkce‚Äú:
      // showLoginOverlay(true);
    }
    return user;
  }

  /******************************************************************
   * 6) ONLINE + OFFLINE QUEUE (Outbox)
   ******************************************************************/
  const OUTBOX_KEY = "merch_outbox_v1";
  const LOCAL_CACHE_KEY = "merch_cache_events_v1"; // lok√°ln√≠ cache event≈Ø (pro UI/rychlost)
  const LOCAL_CACHE_MAX = 2000; // limit event≈Ø v cache

  function outboxLoad(){
    try{
      const raw = localStorage.getItem(OUTBOX_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function outboxSave(arr){
    localStorage.setItem(OUTBOX_KEY, JSON.stringify(arr));
  }

  function cacheLoad(){
    try{
      const raw = localStorage.getItem(LOCAL_CACHE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function cacheSave(arr){
    const sliced = arr.slice(-LOCAL_CACHE_MAX);
    localStorage.setItem(LOCAL_CACHE_KEY, JSON.stringify(sliced));
  }

  function uuid(){
    return (crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2)));
  }

  function buildEventRow({kind, ts, session_id=null, store_name=null, lat=null, lon=null, acc=null, payload={}}){
    const iso = new Date(ts).toISOString();
    const day = iso.slice(0,10); // YYYY-MM-DD
    return {
      client_event_id: uuid(),  // jen lok√°lnƒõ, v DB je vlastn√≠ id
      kind,
      ts: iso,
      day,
      session_id,
      store_name,
      lat, lon, acc,
      payload
    };
  }

  async function pushEventToSupabase(row){
    const user = await getUser();
    if(!user) throw new Error("NOT_SIGNED_IN");

    const insertRow = {
      user_id: user.id,
      kind: row.kind,
      ts: row.ts,
      day: row.day,
      session_id: row.session_id,
      store_name: row.store_name,
      lat: row.lat,
      lon: row.lon,
      acc: row.acc,
      payload: row.payload || {}
    };

    const { error } = await supabase.from("attendance_events").insert(insertRow);
    if(error) throw error;
  }

  async function queueAndTrySend(row){
    // 1) v≈ædy ulo≈æ do outboxu (aby se nic neztratilo)
    const ob = outboxLoad();
    ob.push(row);
    outboxSave(ob);

    // 2) ulo≈æ do lok√°ln√≠ cache pro UI (okam≈æitƒõ)
    const cache = cacheLoad();
    cache.push(row);
    cacheSave(cache);

    // 3) pokus se odeslat (pokud jde)
    try{
      await pushEventToSupabase(row);
      // kdy≈æ ok ‚Üí odeber z outboxu (prvn√≠ v√Ωskyt client_event_id)
      const ob2 = outboxLoad().filter(x => x.client_event_id !== row.client_event_id);
      outboxSave(ob2);
      setSyncBadge({state:"ok", text: ob2.length ? `sync: ${ob2.length} ƒçek√°` : "sync: ok"});
    }catch(e){
      // z≈Øst√°v√° v outboxu
      const ob3 = outboxLoad();
      setSyncBadge({state:navigator.onLine ? "warn" : "bad", text: `ƒçek√°: ${ob3.length}`});
      throw e;
    }
  }

  async function syncOutbox(){
    const user = await getUser();
    const ob = outboxLoad();
    if(!ob.length){
      setSyncBadge({state: navigator.onLine ? "ok" : "bad", text: navigator.onLine ? "sync: ok" : "offline"});
      return;
    }
    if(!user){
      setSyncBadge({state:"warn", text:`ƒçek√°: ${ob.length} (bez loginu)`});
      return;
    }
    if(!navigator.onLine){
      setSyncBadge({state:"bad", text:`offline (ƒçek√°: ${ob.length})`});
      return;
    }

    // po≈°li postupnƒõ (jednoduch√©, robustn√≠)
    let sent = 0;
    const remaining = [];
    for(const row of ob){
      try{
        await pushEventToSupabase(row);
        sent++;
      }catch(e){
        remaining.push(row);
      }
    }
    outboxSave(remaining);
    setSyncBadge({state: remaining.length ? "warn" : "ok", text: remaining.length ? `ƒçek√°: ${remaining.length}` : `sync: ok`});
    if(sent) setStatus(`odesl√°no ${sent} z√°znam≈Ø ‚úÖ`);
  }

  /******************************************************************
   * 7) FETCH Z CLOUDU (pro export a obnovu po smaz√°n√≠ cache)
   ******************************************************************/
  async function fetchMonthEvents(year, month1to12){
    const user = await getUser();
    if(!user) throw new Error("NOT_SIGNED_IN");

    const from = new Date(year, month1to12-1, 1, 0,0,0,0).toISOString();
    const to = new Date(year, month1to12, 1, 0,0,0,0).toISOString();

    const { data, error } = await supabase
      .from("attendance_events")
      .select("*")
      .gte("ts", from)
      .lt("ts", to)
      .order("ts", { ascending: true });

    if(error) throw error;
    return data || [];
  }

  async function fetchTodayEvents(){
    const user = await getUser();
    if(!user) return []; // pro UI pou≈æijeme cache
    const dk = todayKey();
    const from = new Date(dk + "T00:00:00").toISOString();
    const to = new Date(dk + "T23:59:59.999").toISOString();

    const { data, error } = await supabase
      .from("attendance_events")
      .select("*")
      .gte("ts", from)
      .lte("ts", to)
      .order("ts", { ascending: true });

    if(error) throw error;
    return data || [];
  }

  /******************************************************************
   * 8) DOM√âNOV√Å LOGIKA (sessions/visits z event≈Ø)
   ******************************************************************/
  function normalizeRow(r){
    // r m≈Ø≈æe b√Ωt z cache (client_event_id) nebo z DB (id)
    return {
      id: r.id || r.client_event_id || uuid(),
      kind: r.kind,
      ts: (typeof r.ts === "string") ? r.ts : new Date(r.ts).toISOString(),
      day: r.day || (typeof r.ts === "string" ? r.ts.slice(0,10) : fmtDate(r.ts)),
      session_id: r.session_id || null,
      store_name: r.store_name || null,
      lat: (r.lat ?? r.latitude ?? null),
      lon: (r.lon ?? r.longitude ?? null),
      acc: (r.acc ?? r.accuracy ?? null),
      payload: r.payload || {}
    };
  }

  function deriveTodayStateFromEvents(rows){
    const events = rows.map(normalizeRow).filter(r => r.day === todayKey()).sort((a,b)=>a.ts.localeCompare(b.ts));

    // sessions keyed by session_id (SHIFT_START creates it)
    const sessions = new Map();
    const trainings = [];
    const sickness = [];
    let vacation = false;

    for(const e of events){
      if(e.kind === "SHIFT_START"){
        const sid = e.session_id || uuid();
        if(!sessions.has(sid)) sessions.set(sid, { session_id: sid, start: e, end: null, visits: [] });
      }
      if(e.kind === "SHIFT_END"){
        const sid = e.session_id;
        if(sid && sessions.has(sid)) sessions.get(sid).end = e;
      }
      if(e.kind === "STORE_IN"){
        const sid = e.session_id;
        const vid = e.payload?.visit_id || uuid();
        const rec = { visit_id: vid, store_name: e.store_name || e.payload?.store_name || "", in: e, out: null };
        if(sid){
          if(!sessions.has(sid)) sessions.set(sid, { session_id: sid, start: null, end: null, visits: [] });
          sessions.get(sid).visits.push(rec);
        }
      }
      if(e.kind === "STORE_OUT"){
        const sid = e.session_id;
        const vid = e.payload?.visit_id;
        if(sid && vid && sessions.has(sid)){
          const s = sessions.get(sid);
          // najdi posledn√≠ visit s visit_id bez out
          const v = [...s.visits].reverse().find(x => x.visit_id === vid && !x.out);
          if(v) v.out = e;
        }
      }
      if(e.kind === "TRAINING"){
        trainings.push(e);
      }
      if(e.kind === "SICK"){
        sickness.push(e);
      }
      if(e.kind === "VACATION"){
        vacation = true;
      }
    }

    // active session = posledn√≠ s start!=null a end==null
    const sessArr = Array.from(sessions.values()).sort((a,b)=>{
      const ats = a.start?.ts || "";
      const bts = b.start?.ts || "";
      return ats.localeCompare(bts);
    });

    const activeSession = [...sessArr].reverse().find(s => s.start && !s.end) || null;
    let activeVisit = null;
    if(activeSession){
      activeVisit = [...activeSession.visits].reverse().find(v => v.in && !v.out) || null;
    }

    return { events, sessions: sessArr, activeSession, activeVisit, trainings, sickness, vacation };
  }

  /******************************************************************
   * 9) AKCE (logov√°n√≠)
   ******************************************************************/
  async function startShift(){
    const ok = await confirmAction("P≈ôejete si potvrdit p≈ô√≠chod do pr√°ce?");
    if(!ok) return;

    // pokud u≈æ bƒõ≈æ√≠ session dnes, nedovol
    const st = deriveTodayStateFromEvents(cacheLoad());
    if(st.activeSession){
      setStatus("smƒõna u≈æ bƒõ≈æ√≠ (nejd≈ô√≠v dej odchod).");
      render();
      return;
    }

    lockUI(true);
    setStatus("ukl√°d√°m p≈ô√≠chod‚Ä¶");

    const p = await capturePoint();
    const session_id = uuid();

    const row = buildEventRow({
      kind: "SHIFT_START",
      ts: p.ts,
      session_id,
      lat: p.lat, lon: p.lon, acc: p.acc,
      payload: { app_version: "supabase_v1" }
    });

    try{
      await queueAndTrySend(row);
      setStatus(p.geoOk ? "p≈ô√≠chod ulo≈æen ‚úÖ (s GPS)" : `p≈ô√≠chod ulo≈æen ‚úÖ (bez GPS: ${p.geoErr})`);
    }catch(e){
      setStatus("ulo≈æeno offline do fronty ‚úÖ");
    }finally{
      lockUI(false);
      render();
    }
  }

  async function endShift(){
    const ok = await confirmAction("P≈ôejete si potvrdit odchod z pr√°ce?");
    if(!ok) return;

    const st = deriveTodayStateFromEvents(cacheLoad());
    const s = st.activeSession;
    if(!s){
      setStatus("≈æ√°dn√° smƒõna nebƒõ≈æ√≠.");
      render();
      return;
    }
    if(st.activeVisit){
      alert("Nejd≈ô√≠v ukonƒçi n√°v≈°tƒõvu prodejny (odchod z prodejny).");
      return;
    }

    lockUI(true);
    setStatus("ukl√°d√°m odchod‚Ä¶");

    const p = await capturePoint();

    const row = buildEventRow({
      kind: "SHIFT_END",
      ts: p.ts,
      session_id: s.session_id,
      lat: p.lat, lon: p.lon, acc: p.acc,
      payload: { app_version: "supabase_v1" }
    });

    try{
      await queueAndTrySend(row);
      const workMin = minutesDiff(Date.parse(s.start.ts), p.ts);
      setStatus(p.geoOk ? `odchod ulo≈æen ‚úÖ (celkem ${hm(workMin)})` : `odchod ulo≈æen ‚úÖ (bez GPS: ${p.geoErr})`);
    }catch(e){
      setStatus("ulo≈æeno offline do fronty ‚úÖ");
    }finally{
      lockUI(false);
      render();
    }
  }

  async function storeIn(){
    const name = (inpStore.value || "").trim();
    if(!name){
      alert("Zadej n√°zev prodejny.");
      inpStore.focus();
      return;
    }

    const st = deriveTodayStateFromEvents(cacheLoad());
    const s = st.activeSession;
    if(!s){
      alert("Nejd≈ô√≠v zahaj smƒõnu (P≈ô√≠chod).");
      return;
    }
    if(st.activeVisit){
      alert("U≈æ m√°≈° aktivn√≠ n√°v≈°tƒõvu. Nejd≈ô√≠v dej odchod z prodejny.");
      return;
    }

    const ok = await confirmAction(`P≈ôejete si potvrdit VSTUP na prodejnu?\n\nProdejna: ${name}`);
    if(!ok) return;

    lockUI(true);
    setStatus("ukl√°d√°m vstup na prodejnu‚Ä¶");

    const p = await capturePoint();
    const visit_id = uuid();

    const row = buildEventRow({
      kind: "STORE_IN",
      ts: p.ts,
      session_id: s.session_id,
      store_name: name,
      lat: p.lat, lon: p.lon, acc: p.acc,
      payload: { visit_id, store_name: name }
    });

    try{
      await queueAndTrySend(row);
      setStatus(p.geoOk ? "vstup ulo≈æen ‚úÖ (s GPS)" : `vstup ulo≈æen ‚úÖ (bez GPS: ${p.geoErr})`);
    }catch(e){
      setStatus("ulo≈æeno offline do fronty ‚úÖ");
    }finally{
      lockUI(false);
      render();
    }
  }

  async function storeOut(){
    const st = deriveTodayStateFromEvents(cacheLoad());
    const s = st.activeSession;
    const v = st.activeVisit;

    if(!s){
      alert("Nejd≈ô√≠v zahaj smƒõnu (P≈ô√≠chod).");
      return;
    }
    if(!v){
      alert("≈Ω√°dn√° aktivn√≠ n√°v≈°tƒõva nen√≠ otev≈ôen√°.");
      return;
    }

    const storeName = v.store_name || v.in.store_name || "(bez n√°zvu)";
    const ok = await confirmAction(`P≈ôejete si potvrdit ODCHOD z prodejny?\n\nProdejna: ${storeName}`);
    if(!ok) return;

    lockUI(true);
    setStatus("ukl√°d√°m odchod z prodejny‚Ä¶");

    const p = await capturePoint();

    const row = buildEventRow({
      kind: "STORE_OUT",
      ts: p.ts,
      session_id: s.session_id,
      store_name: storeName,
      lat: p.lat, lon: p.lon, acc: p.acc,
      payload: { visit_id: v.visit_id, store_name: storeName }
    });

    try{
      await queueAndTrySend(row);
      const vMin = minutesDiff(Date.parse(v.in.ts), p.ts);
      setStatus(p.geoOk ? `odchod ulo≈æen ‚úÖ (n√°v≈°tƒõva ${hm(vMin)})` : `odchod ulo≈æen ‚úÖ (bez GPS: ${p.geoErr})`);
    }catch(e){
      setStatus("ulo≈æeno offline do fronty ‚úÖ");
    }finally{
      lockUI(false);
      render();
    }
  }

  /******************************************************************
   * 10) MENU FUNKCE: ≈°kolen√≠ / nemoc / dovolen√°
   ******************************************************************/
  function openTrainingForm(){
    closeDrawer();
    const now = Date.now();
    const startDefault = dtLocalValue(now);
    const endDefault = dtLocalValue(now + 60*60000);

    openForm({
      title: "≈†kolen√≠ (placen√©)",
      bodyHtml: `
        <div class="formRow">
          <label class="label" for="trStart">Od</label>
          <input class="input" type="datetime-local" id="trStart" value="${startDefault}">
        </div>
        <div class="formRow">
          <label class="label" for="trEnd">Do</label>
          <input class="input" type="datetime-local" id="trEnd" value="${endDefault}">
        </div>
        <div class="tiny" style="margin-top:10px">Ulo≈æ√≠ se jako placen√© ≈°kolen√≠ (event TRAINING).</div>
      `,
      buttons: [
        { text:"Ulo≈æit", cls:"btn green", onClick: async () => {
          const ok = await confirmAction("Potvrdit ulo≈æen√≠ ≈°kolen√≠?");
          if(!ok) return;

          const s = $id("trStart").value;
          const e = $id("trEnd").value;
          const startTs = Date.parse(s);
          const endTs = Date.parse(e);

          if(!Number.isFinite(startTs) || !Number.isFinite(endTs) || endTs <= startTs){
            alert("Neplatn√Ω ƒçasov√Ω rozsah.");
            return;
          }

          const minutes = minutesDiff(startTs, endTs) ?? 0;
          const row = buildEventRow({
            kind: "TRAINING",
            ts: startTs,
            payload: { start_ts: new Date(startTs).toISOString(), end_ts: new Date(endTs).toISOString(), minutes }
          });

          lockUI(true);
          try{
            await queueAndTrySend(row);
            setStatus("≈°kolen√≠ ulo≈æeno ‚úÖ");
          }catch{
            setStatus("≈°kolen√≠ ulo≈æeno offline do fronty ‚úÖ");
          }finally{
            lockUI(false);
            closeForm();
            render();
          }
        }},
        { text:"Zru≈°it", cls:"btn red", onClick: async () => closeForm() }
      ]
    });
  }

  function openSickForm(){
    closeDrawer();
    const now = Date.now();
    const startDefault = dtLocalValue(now);
    const endDefault = dtLocalValue(now + 8*60*60000);

    openForm({
      title: "Nemoc (neplacen√°)",
      bodyHtml: `
        <div class="formRow">
          <label class="label" for="siStart">Od</label>
          <input class="input" type="datetime-local" id="siStart" value="${startDefault}">
        </div>
        <div class="formRow">
          <label class="label" for="siEnd">Do</label>
          <input class="input" type="datetime-local" id="siEnd" value="${endDefault}">
        </div>
        <div class="tiny" style="margin-top:10px">Ulo≈æ√≠ se jako event SICK (neplacen√©). </div>
      `,
      buttons: [
        { text:"Ulo≈æit", cls:"btn green", onClick: async () => {
          const ok = await confirmAction("Potvrdit ulo≈æen√≠ nemoci?");
          if(!ok) return;

          const s = $id("siStart").value;
          const e = $id("siEnd").value;
          const startTs = Date.parse(s);
          const endTs = Date.parse(e);

          if(!Number.isFinite(startTs) || !Number.isFinite(endTs) || endTs <= startTs){
            alert("Neplatn√Ω ƒçasov√Ω rozsah.");
            return;
          }

          const minutes = minutesDiff(startTs, endTs) ?? 0;
          const row = buildEventRow({
            kind: "SICK",
            ts: startTs,
            payload: { start_ts: new Date(startTs).toISOString(), end_ts: new Date(endTs).toISOString(), minutes }
          });

          lockUI(true);
          try{
            await queueAndTrySend(row);
            setStatus("nemoc ulo≈æena ‚úÖ");
          }catch{
            setStatus("nemoc ulo≈æena offline do fronty ‚úÖ");
          }finally{
            lockUI(false);
            closeForm();
            render();
          }
        }},
        { text:"Zru≈°it", cls:"btn red", onClick: async () => closeForm() }
      ]
    });
  }

  function openVacationForm(){
    closeDrawer();
    const dk = todayKey();

    openForm({
      title: "Dovolen√°",
      bodyHtml: `
        <div class="formRow">
          <label class="label" for="vacDay">Vyber den</label>
          <input class="input" type="date" id="vacDay" value="${dk}">
        </div>
        <div class="tiny" style="margin-top:10px">
          P≈ôid√° se event VACATION pro vybran√Ω den (poƒç√≠tej 8 hodin v reportu).
        </div>
      `,
      buttons: [
        { text:"P≈ôidat", cls:"btn green", onClick: async () => {
          const day = $id("vacDay").value;
          if(!day){ alert("Vyber den."); return; }
          const ok = await confirmAction(`P≈ôidat dovolenou pro den ${day}?`);
          if(!ok) return;

          const ts = Date.parse(day + "T00:00:00");
          const row = buildEventRow({
            kind: "VACATION",
            ts,
            payload: { day, minutes: 480 }
          });

          lockUI(true);
          try{
            await queueAndTrySend(row);
            setStatus("dovolen√° ulo≈æena ‚úÖ");
          }catch{
            setStatus("dovolen√° ulo≈æena offline do fronty ‚úÖ");
          }finally{
            lockUI(false);
            closeForm();
            render();
          }
        }},
        { text:"Zru≈°it", cls:"btn red", onClick: async () => closeForm() }
      ]
    });
  }

  /******************************************************************
   * 11) EXPORT (CSV) ‚Äì ƒçte z CLOUDU, pokud je login; jinak z cache
   ******************************************************************/
  function parseMonthValue(v){
    if(!v) return null;
    const [y,m] = v.split("-").map(Number);
    if(!y || !m) return null;
    return { y, m };
  }
  function csvEscape(value, sep){
    const s = String(value ?? "");
    const needs = s.includes(sep) || s.includes('"') || s.includes("\n");
    const v = s.replaceAll('"','""');
    return needs ? `"${v}"` : v;
  }

  function groupByDay(rows){
    const by = new Map();
    rows.forEach(r => {
      const e = normalizeRow(r);
      const day = e.day;
      if(!by.has(day)) by.set(day, []);
      by.get(day).push(e);
    });
    for(const arr of by.values()){
      arr.sort((a,b)=>a.ts.localeCompare(b.ts));
    }
    return by;
  }

  function computeDayTotals(dayRows){
    // work minutes = sum of closed sessions
    const sessions = new Map();
    let trainingMin = 0;
    let sickMin = 0;
    let vacationMin = 0;
    let visits = 0;

    for(const e of dayRows){
      if(e.kind === "SHIFT_START"){
        const sid = e.session_id;
        if(sid && !sessions.has(sid)) sessions.set(sid, { start: e, end: null });
      }
      if(e.kind === "SHIFT_END"){
        const sid = e.session_id;
        if(sid){
          if(!sessions.has(sid)) sessions.set(sid, { start: null, end: e });
          else sessions.get(sid).end = e;
        }
      }
      if(e.kind === "STORE_IN") visits++;
      if(e.kind === "TRAINING") trainingMin += (e.payload?.minutes ?? 0);
      if(e.kind === "SICK") sickMin += (e.payload?.minutes ?? 0);
      if(e.kind === "VACATION") vacationMin = 480;
    }

    let workMin = 0;
    for(const s of sessions.values()){
      if(s.start && s.end){
        const m = minutesDiff(Date.parse(s.start.ts), Date.parse(s.end.ts));
        if(m != null) workMin += m;
      }
    }

    const paidMin = workMin + trainingMin + vacationMin;
    return { workMin, trainingMin, sickMin, vacationMin, paidMin, visits };
  }

  async function exportCsv(){
    const sel = parseMonthValue(monthPick.value);
    if(!sel){ alert("Vyber mƒõs√≠c pro export."); return; }

    lockUI(true);
    setStatus("p≈ôipravuju export‚Ä¶");

    let rows = [];
    try{
      const user = await getUser();
      if(user){
        rows = await fetchMonthEvents(sel.y, sel.m);
      }else{
        // fallback: z cache vezmi jen vybran√Ω mƒõs√≠c
        const all = cacheLoad().map(normalizeRow);
        rows = all.filter(r => {
          const d = new Date(r.ts);
          return d.getFullYear() === sel.y && (d.getMonth()+1) === sel.m;
        });
      }
    }catch(e){
      alert("Export selhal: " + (e?.message || e));
      lockUI(false);
      return;
    }

    const byDay = groupByDay(rows);
    const sep = ",";
    const head = [
      "row_type","date",
      "work_minutes","training_minutes","vacation_minutes","sick_minutes","paid_minutes",
      "visit_count",
      "kind","ts","session_id","store_name",
      "lat","lon","acc",
      "payload_json"
    ];
    const lines = [head.join(sep)];

    const days = Array.from(byDay.keys()).sort((a,b)=>a.localeCompare(b));
    for(const day of days){
      const dayRows = byDay.get(day);
      const t = computeDayTotals(dayRows);

      // DAY_TOTAL
      lines.push([
        "DAY_TOTAL", day,
        t.workMin, t.trainingMin, t.vacationMin, t.sickMin, t.paidMin,
        t.visits,
        "", "", "", "",
        "", "", "",
        ""
      ].map(x=>csvEscape(x, sep)).join(sep));

      // EVENTS
      for(const e of dayRows){
        lines.push([
          "EVENT", day,
          "", "", "", "", "",
          "",
          e.kind, e.ts, e.session_id || "", e.store_name || "",
          e.lat ?? "", e.lon ?? "", e.acc ?? "",
          JSON.stringify(e.payload || {})
        ].map(x=>csvEscape(x, sep)).join(sep));
      }
    }

    const csv = "\uFEFF" + lines.join("\n"); // BOM pro Excel
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const fname = `merchandiser_log_${sel.y}_${pad2(sel.m)}.csv`;
    const a = document.createElement("a");
    a.href = url;
    a.download = fname;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    lockUI(false);
    setStatus("export hotovej ‚úÖ");
  }

  /******************************************************************
   * 12) RENDER
   ******************************************************************/
  function updateNow(){
    const d = new Date();
    elNow.textContent = `${d.getDate()}. ${d.getMonth()+1}. ${d.getFullYear()}  ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  function render(){
    updateNow();

    // sync badge
    const ob = outboxLoad();
    if(!navigator.onLine){
      setSyncBadge({state:"bad", text: `offline (ƒçek√°: ${ob.length})`});
    }else{
      setSyncBadge({state: ob.length ? "warn" : "ok", text: ob.length ? `ƒçek√°: ${ob.length}` : "sync: ok"});
    }

    // derive today state from local cache (rychl√©)
    const st = deriveTodayStateFromEvents(cacheLoad());

    if(!st.activeSession) elPill.textContent = "MIMO PRACOVN√ç DOBU";
    else if(st.activeSession && st.activeVisit) elPill.textContent = "NA PRODEJNƒö";
    else elPill.textContent = "VE SMƒöNƒö";

    // requested button behavior:
    btnShiftStart.disabled = !!st.activeSession;
    btnShiftEnd.disabled = !st.activeSession;

    btnStoreIn.disabled = !st.activeSession || !!st.activeVisit;
    btnStoreOut.disabled = !st.activeSession || !st.activeVisit;

    // month default
    if(!monthPick.value) monthPick.value = monthKeyDefault();

    // activity list
    const items = [];

    // sessions + visits
    for(let i=0; i<st.sessions.length; i++){
      const s = st.sessions[i];
      if(s.start){
        items.push({
          tag:`SMƒöNA #${i+1}`,
          title:"P≈ô√≠chod",
          sub:`${fmtDateTime(Date.parse(s.start.ts))} ‚Ä¢ GPS: ${gpsText(s.start)}`
        });
      }
      for(let j=0; j<s.visits.length; j++){
        const v = s.visits[j];
        const inTs = Date.parse(v.in.ts);
        const outTs = v.out ? Date.parse(v.out.ts) : null;
        const dur = outTs ? hm(minutesDiff(inTs, outTs)) : "prob√≠h√°‚Ä¶";
        items.push({
          tag:`PRODEJNA ${i+1}.${j+1}`,
          title: v.store_name || "(bez n√°zvu)",
          sub:`${fmtDateTime(inTs)} ‚Üí ${outTs ? fmtDateTime(outTs) : "‚Äî"} ‚Ä¢ ${dur}`
        });
      }
      if(s.end){
        const w = minutesDiff(Date.parse(s.start.ts), Date.parse(s.end.ts));
        items.push({
          tag:`SMƒöNA #${i+1}`,
          title:"Odchod",
          sub:`${fmtDateTime(Date.parse(s.end.ts))} ‚Ä¢ Celkem: ${hm(w)}`
        });
      }else if(s.start){
        items.push({
          tag:`SMƒöNA #${i+1}`,
          title:"Bƒõ≈æ√≠‚Ä¶",
          sub:"Smƒõna nen√≠ uzav≈ôen√° (ƒçek√° na Odchod)."
        });
      }
    }

    // training/sick/vacation for today
    for(const e of st.trainings){
      items.push({
        tag:"≈†KOLEN√ç",
        title:"≈†kolen√≠ (placen√©)",
        sub:`${e.payload?.start_ts || e.ts} ‚Üí ${e.payload?.end_ts || ""} ‚Ä¢ ${hm(e.payload?.minutes || 0)}`
      });
    }
    for(const e of st.sickness){
      items.push({
        tag:"NEMOC",
        title:"Nemoc (neplacen√°)",
        sub:`${e.payload?.start_ts || e.ts} ‚Üí ${e.payload?.end_ts || ""} ‚Ä¢ ${hm(e.payload?.minutes || 0)}`
      });
    }
    if(st.vacation){
      items.push({ tag:"DOVOLEN√Å", title:"Dovolen√°", sub:"Cel√Ω den (8 hodin)" });
    }

    if(!items.length){
      elActivity.innerHTML = `<div class="tiny">Zat√≠m nic. Klikni na P≈ò√çCHOD.</div>`;
    }else{
      elActivity.innerHTML = items.map(it => `
        <div class="item">
          <div class="itemTop">
            <div>
              <p class="itemTitle">${escapeHtml(it.title)}</p>
              <p class="itemSub mono">${escapeHtml(it.sub)}</p>
            </div>
            <div class="tag">${escapeHtml(it.tag)}</div>
          </div>
        </div>
      `).join("");
    }
  }

  /******************************************************************
   * 13) MENU / SERVIS AKCE
   ******************************************************************/
  async function handleAccountClick(){
    closeDrawer();
    const user = await getUser();
    if(user){
      const ok = await confirmAction("Odhl√°sit se?");
      if(!ok) return;
      await signOut();
      await ensureAuthUI();
      setStatus("odhl√°≈°eno");
      render();
      return;
    }
    showLoginOverlay(true);
  }

  async function clearTodayLocal(){
    closeDrawer();
    const ok = await confirmAction("Vymazat dne≈°n√≠ lok√°ln√≠ cache? (cloud data z≈Øst√°vaj√≠)");
    if(!ok) return;
    const dk = todayKey();
    const cache = cacheLoad().map(normalizeRow).filter(r => r.day !== dk);
    cacheSave(cache);
    // outbox dne≈°ka taky sma≈æeme (jen lok√°lnƒõ) ‚Äì opatrnƒõ: m≈Ø≈æe to zahodit neodeslan√©!
    const ob = outboxLoad().filter(r => (normalizeRow(r).day !== dk));
    outboxSave(ob);
    setStatus("dne≈°ek vymaz√°n lok√°lnƒõ üßº");
    render();
  }

  async function clearAllLocal(){
    closeDrawer();
    const ok = await confirmAction("Vymazat ve≈°ker√° lok√°ln√≠ data? (cloud data z≈Øst√°vaj√≠)");
    if(!ok) return;
    localStorage.removeItem(LOCAL_CACHE_KEY);
    localStorage.removeItem(OUTBOX_KEY);
    setStatus("lok√°ln√≠ data vymaz√°na üßº");
    render();
  }

  /******************************************************************
   * 14) LOGIN HANDLERS
   ******************************************************************/
  btnLogin.addEventListener("click", async () => {
    loginMsg.style.display = "none";
    const email = (loginEmail.value || "").trim();
    const pass = (loginPass.value || "").trim();
    if(!email || !pass){
      loginMsg.textContent = "Zadej email a heslo.";
      loginMsg.style.display = "block";
      return;
    }
    btnLogin.disabled = true;
    try{
      await signIn(email, pass);
      await ensureAuthUI();
      showLoginOverlay(false);
      setStatus("p≈ôihl√°≈°eno ‚úÖ");
      await syncOutbox();
    }catch(e){
      loginMsg.textContent = "P≈ôihl√°≈°en√≠ selhalo: " + (e?.message || e);
      loginMsg.style.display = "block";
    }finally{
      btnLogin.disabled = false;
      render();
    }
  });

  btnLoginLater.addEventListener("click", () => {
    showLoginOverlay(false);
  });

  /******************************************************************
   * 15) WIRE-UP
   ******************************************************************/
  btnShiftStart.addEventListener("click", startShift);
  btnShiftEnd.addEventListener("click", endShift);
  btnStoreIn.addEventListener("click", storeIn);
  btnStoreOut.addEventListener("click", storeOut);
  btnExport.addEventListener("click", exportCsv);

  btnHamb.addEventListener("click", openDrawer);
  drawerClose.addEventListener("click", closeDrawer);
  drawerBack.addEventListener("click", (e) => { if(e.target === drawerBack) closeDrawer(); });

  btnTraining.addEventListener("click", openTrainingForm);
  btnSick.addEventListener("click", openSickForm);
  btnVacation.addEventListener("click", openVacationForm);

  btnAccount.addEventListener("click", handleAccountClick);
  btnSyncNow.addEventListener("click", async () => { closeDrawer(); await syncOutbox(); render(); });
  btnClearToday.addEventListener("click", clearTodayLocal);
  btnClearAllLocal.addEventListener("click", clearAllLocal);

  // online/offline
  window.addEventListener("online", () => { syncOutbox().catch(()=>{}); render(); });
  window.addEventListener("offline", () => { render(); });

  // auth state changes
  supabase.auth.onAuthStateChange((_event, _session) => {
    ensureAuthUI().then(()=>{ render(); syncOutbox().catch(()=>{}); });
  });

  /******************************************************************
   * 16) INIT
   ******************************************************************/
  (async () => {
    // sanity check: pokud nejsou vyplnƒõn√© kl√≠ƒçe, upozorni (ale nech UI bƒõ≈æet lok√°lnƒõ)
    if(SUPABASE_URL.includes("PASTE_") || SUPABASE_ANON_KEY.includes("PASTE_")){
      setStatus("Dopl≈à SUPABASE_URL a SUPABASE_ANON_KEY (zat√≠m jen lok√°lnƒõ).");
      setSyncBadge({state:"warn", text:"bez supabase"});
    }else{
      setSyncBadge({state: navigator.onLine ? "warn" : "bad", text: navigator.onLine ? "ƒçek√°m na login" : "offline"});
    }

    // default month
    if(!monthPick.value) monthPick.value = monthKeyDefault();

    // UI account
    await ensureAuthUI();

    // pokud je user p≈ôihl√°≈°en√Ω, m≈Ø≈æe≈° st√°hnout dne≈°ek z cloudu a p≈ôim√≠chat do cache (aby to p≈ôe≈æilo smaz√°n√≠ cache ‚Üí po loginu se obnov√≠)
    try{
      const user = await getUser();
      if(user && navigator.onLine){
        const todayCloud = await fetchTodayEvents();
        // merge cloud -> cache (de-dupe hrubƒõ podle kind+ts+session_id+store_name)
        const cache = cacheLoad().map(normalizeRow);
        const seen = new Set(cache.map(x => `${x.kind}|${x.ts}|${x.session_id||""}|${x.store_name||""}`));
        for(const r of todayCloud){
          const e = normalizeRow(r);
          const key = `${e.kind}|${e.ts}|${e.session_id||""}|${e.store_name||""}`;
          if(!seen.has(key)){
            cache.push(e);
            seen.add(key);
          }
        }
        cacheSave(cache);
      }
    }catch{
      // ignoruj ‚Äì UI pojede z cache
    }

    // pokus o sync outboxu
    syncOutbox().catch(()=>{});

    // tick + render
    render();
    setInterval(() => { updateNow(); }, 1000);
  })();

  function updateNow(){ // keep it for interval
    const d = new Date();
    elNow.textContent = `${d.getDate()}. ${d.getMonth()+1}. ${d.getFullYear()}  ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

})();
</script>

</body>
</html>
