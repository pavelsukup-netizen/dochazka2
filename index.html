<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MERCHANDISER LOG</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b1020" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Neon / glass background */
    .neon-bg {
      background:
        radial-gradient(900px 500px at 18% 8%, rgba(99,102,241,.38), transparent 60%),
        radial-gradient(700px 500px at 82% 16%, rgba(236,72,153,.22), transparent 55%),
        radial-gradient(650px 650px at 65% 78%, rgba(34,197,94,.16), transparent 60%),
        radial-gradient(900px 600px at 10% 92%, rgba(59,130,246,.16), transparent 60%),
        linear-gradient(180deg, #070a14 0%, #0a0f21 40%, #070a14 100%);
    }
    .glass {
      background: rgba(17, 24, 39, 0.55);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid rgba(148,163,184,.16);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .glass-soft {
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid rgba(148,163,184,.12);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .glow-line {
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(99,102,241,.0), rgba(99,102,241,.9), rgba(236,72,153,.9), rgba(34,197,94,.0));
      filter: drop-shadow(0 0 14px rgba(236,72,153,.35));
    }
    .btn-glow-green { box-shadow: 0 18px 40px rgba(0,0,0,.35), 0 0 26px rgba(34,197,94,.20); }
    .btn-glow-red   { box-shadow: 0 18px 40px rgba(0,0,0,.35), 0 0 26px rgba(239,68,68,.18); }
    .btn-glow-blue  { box-shadow: 0 18px 40px rgba(0,0,0,.35), 0 0 26px rgba(59,130,246,.18); }
    .btn-glow-amber { box-shadow: 0 18px 40px rgba(0,0,0,.35), 0 0 26px rgba(245,158,11,.18); }

    /* overlay stacking */
    #drawerBack { z-index: 8000; }
    #formBack { z-index: 9000; }
    #modalBack { z-index: 10000; }
    #loginBack { z-index: 11000; }

    /* dot states (keep JS logic) */
    .dot{ width:10px; height:10px; border-radius:999px; background:#94a3b8; }
    .dot.ok{ background:#22c55e; box-shadow: 0 0 14px rgba(34,197,94,.40); }
    .dot.warn{ background:#f59e0b; box-shadow: 0 0 14px rgba(245,158,11,.35); }
    .dot.bad{ background:#ef4444; box-shadow: 0 0 14px rgba(239,68,68,.30); }
  </style>
</head>

<body class="min-h-screen neon-bg text-slate-100">
  <div class="mx-auto w-full max-w-[480px] px-4 py-6">
    <!-- HEADER CARD -->
    <div class="glass rounded-[28px] overflow-hidden">
      <div class="glow-line"></div>

      <div class="p-5">
        <div class="flex items-start justify-between gap-3">
          <!-- Left: account shortcut (opens drawer account action in your logic) -->
          <div class="flex flex-col items-center gap-2">
            <div class="h-14 w-14 rounded-2xl glass-soft flex items-center justify-center border border-slate-400/15">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" class="opacity-90">
                <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5Z" stroke="currentColor" stroke-width="1.8"/>
                <path d="M20 22a8 8 0 1 0-16 0" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="text-[11px] font-extrabold tracking-widest uppercase text-slate-300">LOGIN</div>
          </div>

          <!-- Center title -->
          <div class="flex-1 text-center pt-1">
            <div class="text-xl font-black tracking-wide">MERCHANDISER LOG</div>
            <div class="mt-1 text-sm text-slate-300">
              <span id="nowText" class="font-semibold">--</span>
            </div>
          </div>

          <!-- Right hamburger -->
          <button id="btnHamb"
            class="h-12 w-12 rounded-2xl glass-soft flex items-center justify-center border border-slate-400/15 hover:border-slate-200/20 transition active:scale-[.99]"
            title="Menu">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" class="opacity-90">
              <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>

        <!-- Status LED row -->
        <div class="mt-4 grid grid-cols-3 gap-3">
          <div class="glass-soft rounded-2xl px-3 py-2 flex items-center justify-center gap-2 border border-slate-400/10">
            <span class="h-2.5 w-2.5 rounded-full bg-emerald-400 shadow-[0_0_14px_rgba(34,197,94,.45)]"></span>
            <span class="text-[11px] font-extrabold tracking-widest text-slate-200">GPS</span>
          </div>
          <div class="glass-soft rounded-2xl px-3 py-2 flex items-center justify-center gap-2 border border-slate-400/10">
            <span class="h-2.5 w-2.5 rounded-full bg-emerald-400 shadow-[0_0_14px_rgba(34,197,94,.45)]"></span>
            <span class="text-[11px] font-extrabold tracking-widest text-slate-200">ONLINE</span>
          </div>
          <div class="glass-soft rounded-2xl px-3 py-2 flex items-center justify-center gap-2 border border-slate-400/10">
            <span class="dot" id="syncDot"></span>
            <span class="text-[11px] font-extrabold tracking-widest text-slate-200">AUTH</span>
          </div>
        </div>

        <!-- Mode pill -->
        <div class="mt-4 flex justify-center">
          <div id="modePill"
            class="px-5 py-2 rounded-full glass-soft border border-rose-400/20 text-rose-200 text-[11px] font-extrabold tracking-widest uppercase shadow-[0_0_24px_rgba(244,63,94,.14)]">
            MIMO PRACOVN√ç DOBU
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN CARD -->
    <div class="mt-5 glass rounded-[28px] p-5">
      <!-- Work shift -->
      <div class="text-[11px] font-extrabold tracking-widest text-slate-400 uppercase mb-3">PRACOVN√ç SMƒöNA</div>
      <div class="grid grid-cols-2 gap-4">
        <button id="btnShiftStart"
          class="rounded-2xl py-5 text-emerald-300 font-black tracking-widest bg-emerald-500/15 border border-emerald-400/20 btn-glow-green active:scale-[.99] transition disabled:opacity-40 disabled:cursor-not-allowed">
          P≈ò√çCHOD
        </button>
        <button id="btnShiftEnd"
          class="rounded-2xl py-5 text-rose-300 font-black tracking-widest bg-rose-500/12 border border-rose-400/20 btn-glow-red active:scale-[.99] transition disabled:opacity-40 disabled:cursor-not-allowed">
          ODCHOD
        </button>
      </div>

      <div class="my-5 h-px bg-slate-200/10"></div>

      <!-- Store visit -->
      <div class="text-[11px] font-extrabold tracking-widest text-slate-400 uppercase mb-3">N√ÅV≈†TƒöVA PRODEJNY</div>
      <input id="storeName"
        class="w-full rounded-2xl px-4 py-4 bg-slate-950/35 border border-slate-400/15 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/35 focus:border-indigo-300/25 disabled:opacity-50"
        placeholder="N√°zev prodejny (nap≈ô. Albert Andƒõl)" />

      <div class="mt-4 grid grid-cols-2 gap-4">
        <button id="btnStoreIn"
          class="rounded-2xl py-5 text-sky-200 font-black tracking-widest bg-sky-500/15 border border-sky-300/20 btn-glow-blue active:scale-[.99] transition disabled:opacity-40 disabled:cursor-not-allowed">
          VSTUP NA<br><span class="text-[10px] opacity-80">PRODEJNU</span>
        </button>
        <button id="btnStoreOut"
          class="rounded-2xl py-5 text-amber-200 font-black tracking-widest bg-amber-400/15 border border-amber-200/20 btn-glow-amber active:scale-[.99] transition disabled:opacity-40 disabled:cursor-not-allowed">
          ODCHOD Z<br><span class="text-[10px] opacity-80">PRODEJNY</span>
        </button>
      </div>

      <div class="my-5 h-px bg-slate-200/10"></div>

      <!-- Export -->
      <div class="grid grid-cols-[1fr_150px] gap-3 items-center">
        <button id="btnExport"
          class="rounded-2xl py-4 font-black tracking-widest bg-slate-950/40 border border-slate-400/15 hover:border-slate-200/20 active:scale-[.99] transition disabled:opacity-40 disabled:cursor-not-allowed">
          <span class="inline-flex items-center justify-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-85">
              <path d="M12 3v12m0 0 4-4m-4 4-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M4 17v3h16v-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Export CSV
          </span>
        </button>

        <input id="monthPick" type="month"
          class="rounded-2xl px-3 py-4 bg-slate-950/35 border border-slate-400/15 text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/35 focus:border-indigo-300/25 disabled:opacity-50" />
      </div>

      <!-- Status bar (kept IDs) -->
      <div class="mt-4 glass-soft rounded-2xl px-4 py-4 border border-slate-400/10">
        <div class="flex items-center justify-between gap-3">
          <div class="text-[11px] font-extrabold tracking-widest text-slate-400 uppercase">STATUS</div>
          <div class="text-sm font-black tracking-wide text-slate-100" id="statusText">Stav: p≈ôipraveno.</div>
        </div>
        <div class="mt-2 text-[11px] text-slate-400">
          <span id="syncText">offline</span>
        </div>
      </div>

      <!-- Activity -->
      <div class="mt-6 text-[11px] font-extrabold tracking-widest text-slate-400 uppercase">DNE≈†N√ç AKTIVITA</div>
      <div id="activity" class="mt-3 space-y-3"></div>

      <div class="mt-4 text-[11px] text-slate-500">
        ‚Ä¢ Data se ukl√°daj√≠ online na Supabase (po p≈ôihl√°≈°en√≠). Kdy≈æ nen√≠ sign√°l, ukl√°d√° se do fronty a ode≈°le se pozdƒõji.
      </div>
    </div>

    <div class="mt-5 text-center text-[10px] text-slate-600 tracking-widest opacity-70">
      MERCHANDISER LOG ‚Ä¢ NEON/GLASS UI
    </div>
  </div>

  <!-- Confirm modal -->
  <div id="modalBack" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-5" aria-hidden="true">
    <div class="glass rounded-3xl w-full max-w-[430px] overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200/10 font-black tracking-wide">Potvrzen√≠</div>
      <div class="px-5 py-5">
        <p id="modalMsg" class="text-slate-200 font-semibold whitespace-pre-wrap">--</p>
      </div>
      <div class="px-5 py-4 border-t border-slate-200/10 flex gap-3">
        <button id="modalYes" class="flex-1 rounded-2xl py-3 font-black tracking-widest bg-emerald-500/20 border border-emerald-300/20 btn-glow-green active:scale-[.99] transition">
          ANO
        </button>
        <button id="modalNo" class="flex-1 rounded-2xl py-3 font-black tracking-widest bg-rose-500/18 border border-rose-300/20 btn-glow-red active:scale-[.99] transition">
          NE
        </button>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div id="drawerBack" class="fixed inset-0 bg-black/45 hidden" aria-hidden="true">
    <div class="absolute right-0 top-0 h-full w-[92vw] max-w-[380px] glass border-l border-slate-200/10">
      <div class="px-5 py-4 border-b border-slate-200/10 flex items-center justify-between">
        <div class="font-black tracking-wide" id="drawerTitle">MENU</div>
        <button id="drawerClose" class="h-10 w-10 rounded-2xl glass-soft border border-slate-200/10 flex items-center justify-center active:scale-[.99] transition">
          ‚úï
        </button>
      </div>

      <div class="p-5 space-y-3 overflow-auto h-[calc(100%-72px)]">
        <div class="text-[11px] font-extrabold tracking-widest text-slate-400 uppercase">Doch√°zka</div>

        <button id="btnTraining" class="w-full glass-soft rounded-2xl px-4 py-4 border border-slate-200/10 flex items-center justify-between active:scale-[.99] transition">
          <span class="font-bold">≈†kolen√≠ (placen√©)</span>
          <span class="text-[11px] font-extrabold tracking-widest px-3 py-1 rounded-full bg-slate-950/35 border border-slate-200/10">od‚Äìdo</span>
        </button>

        <button id="btnSick" class="w-full glass-soft rounded-2xl px-4 py-4 border border-slate-200/10 flex items-center justify-between active:scale-[.99] transition">
          <span class="font-bold">Nemoc (neplacen√°)</span>
          <span class="text-[11px] font-extrabold tracking-widest px-3 py-1 rounded-full bg-slate-950/35 border border-slate-200/10">od‚Äìdo</span>
        </button>

        <button id="btnVacation" class="w-full glass-soft rounded-2xl px-4 py-4 border border-slate-200/10 flex items-center justify-between active:scale-[.99] transition">
          <span class="font-bold">Dovolen√°</span>
          <span class="text-[11px] font-extrabold tracking-widest px-3 py-1 rounded-full bg-slate-950/35 border border-slate-200/10">dny</span>
        </button>

        <div class="mt-4 text-[11px] font-extrabold tracking-widest text-slate-400 uppercase">√öƒçet</div>
        <button id="btnAccount" class="w-full glass-soft rounded-2xl px-4 py-4 border border-slate-200/10 flex items-center justify-between active:scale-[.99] transition">
          <span class="font-bold" id="accountLabel">Nep≈ôihl√°≈°en</span>
          <span class="text-[11px] font-extrabold tracking-widest px-3 py-1 rounded-full bg-slate-950/35 border border-slate-200/10" id="accountChip">login</span>
        </button>

        <div class="mt-4 text-[11px] font-extrabold tracking-widest text-slate-400 uppercase">Servis</div>
        <button id="btnSyncNow" class="w-full glass-soft rounded-2xl px-4 py-4 border border-slate-200/10 flex items-center justify-between active:scale-[.99] transition">
          <span class="font-bold">Odeslat ƒçekaj√≠c√≠ z√°znamy</span>
          <span class="text-[11px] font-extrabold tracking-widest px-3 py-1 rounded-full bg-slate-950/35 border border-slate-200/10">sync</span>
        </button>

        <button id="btnClearToday" class="w-full glass-soft rounded-2xl px-4 py-4 border border-slate-200/10 flex items-center justify-between active:scale-[.99] transition">
          <span class="font-bold">Vymazat dne≈°n√≠ lok√°ln√≠ cache</span>
          <span class="text-[11px] font-extrabold tracking-widest px-3 py-1 rounded-full bg-rose-500/15 border border-rose-300/15 text-rose-200">lok√°l</span>
        </button>

        <button id="btnClearAllLocal" class="w-full glass-soft rounded-2xl px-4 py-4 border border-slate-200/10 flex items-center justify-between active:scale-[.99] transition">
          <span class="font-bold">Vymazat ve≈°ker√° lok√°ln√≠ data</span>
          <span class="text-[11px] font-extrabold tracking-widest px-3 py-1 rounded-full bg-rose-500/15 border border-rose-300/15 text-rose-200">lok√°l</span>
        </button>

        <div class="text-[11px] text-slate-500">
          Tip: po update PWA nƒõkdy pom≈Ø≈æe smazat data webu (Chrome ‚Üí üîí ‚Üí √ölo≈æi≈°tƒõ ‚Üí Vymazat data).
        </div>
      </div>
    </div>
  </div>

  <!-- Form modal -->
  <div id="formBack" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-5" aria-hidden="true">
    <div class="glass rounded-3xl w-full max-w-[430px] overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200/10 font-black tracking-wide" id="formTitle">Formul√°≈ô</div>
      <div class="px-5 py-5" id="formBody"></div>
      <div class="px-5 py-4 border-t border-slate-200/10 flex gap-3" id="formActions"></div>
    </div>
  </div>

  <!-- Login overlay -->
  <div id="loginBack" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-5" aria-hidden="true">
    <div class="glass rounded-3xl w-full max-w-[430px] overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200/10 font-black tracking-wide">P≈ôihl√°≈°en√≠</div>
      <div class="px-5 py-5">
        <div class="text-[12px] text-slate-400 mb-4">P≈ôihl√°≈°en√≠ je pot≈ôeba, aby se doch√°zka ukl√°dala online.</div>

        <label class="block text-[11px] font-extrabold tracking-widest text-slate-400 uppercase mb-2">Email</label>
        <input id="loginEmail" type="email"
          class="w-full rounded-2xl px-4 py-4 bg-slate-950/35 border border-slate-400/15 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/35 focus:border-indigo-300/25"
          placeholder="name@company.cz" />

        <div class="h-4"></div>

        <label class="block text-[11px] font-extrabold tracking-widest text-slate-400 uppercase mb-2">Heslo</label>
        <input id="loginPass" type="password"
          class="w-full rounded-2xl px-4 py-4 bg-slate-950/35 border border-slate-400/15 text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/35 focus:border-indigo-300/25"
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

        <div id="loginMsg" class="mt-3 text-[12px] text-rose-300 hidden"></div>
      </div>

      <div class="px-5 py-4 border-t border-slate-200/10 flex gap-3">
        <button id="btnLogin" class="flex-1 rounded-2xl py-3 font-black tracking-widest bg-emerald-500/20 border border-emerald-300/20 btn-glow-green active:scale-[.99] transition">
          P≈ôihl√°sit
        </button>
        <button id="btnResetPass" class="flex-1 rounded-2xl py-3 font-black tracking-widest bg-slate-950/35 border border-slate-200/10 active:scale-[.99] transition">
          Reset hesla
        </button>
        <button id="btnLoginLater" class="flex-1 rounded-2xl py-3 font-black tracking-widest bg-slate-950/35 border border-slate-200/10 active:scale-[.99] transition">
          Pozdƒõji
        </button>
      </div>
    </div>
  </div>

<script>
(() => {
  /******************************************************************
   * 0) SUPABASE KONFIGURACE
   ******************************************************************/
  const SUPABASE_URL = "https://rzjgpjhtqzoafzndeqox.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6amdwamh0cXpvYWZ6bmRlcW94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjI1NTUsImV4cCI6MjA4NzUzODU1NX0.Awfj2HOpap8e2wRUtDUZZYh2AKeGoQPkMVwTbZ1qvkA";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /******************************************************************
   * 1) DOM
   ******************************************************************/
  const elNow = document.getElementById("nowText");
  const elPill = document.getElementById("modePill");

  const elStatusText = document.getElementById("statusText");
  const elSyncDot = document.getElementById("syncDot");
  const elSyncText = document.getElementById("syncText");

  const elActivity = document.getElementById("activity");

  const btnShiftStart = document.getElementById("btnShiftStart");
  const btnShiftEnd = document.getElementById("btnShiftEnd");
  const btnStoreIn = document.getElementById("btnStoreIn");
  const btnStoreOut = document.getElementById("btnStoreOut");
  const btnExport = document.getElementById("btnExport");
  const inpStore = document.getElementById("storeName");
  const monthPick = document.getElementById("monthPick");

  // confirm modal
  const modalBack = document.getElementById("modalBack");
  const modalMsg = document.getElementById("modalMsg");
  const modalYes = document.getElementById("modalYes");
  const modalNo = document.getElementById("modalNo");

  // drawer
  const btnHamb = document.getElementById("btnHamb");
  const drawerBack = document.getElementById("drawerBack");
  const drawerClose = document.getElementById("drawerClose");
  const btnTraining = document.getElementById("btnTraining");
  const btnSick = document.getElementById("btnSick");
  const btnVacation = document.getElementById("btnVacation");
  const btnAccount = document.getElementById("btnAccount");
  const accountLabel = document.getElementById("accountLabel");
  const accountChip = document.getElementById("accountChip");
  const btnSyncNow = document.getElementById("btnSyncNow");
  const btnClearToday = document.getElementById("btnClearToday");
  const btnClearAllLocal = document.getElementById("btnClearAllLocal");

  // form modal
  const formBack = document.getElementById("formBack");
  const formTitle = document.getElementById("formTitle");
  const formBody = document.getElementById("formBody");
  const formActions = document.getElementById("formActions");

  // login overlay
  const loginBack = document.getElementById("loginBack");
  const loginEmail = document.getElementById("loginEmail");
  const loginPass = document.getElementById("loginPass");
  const loginMsg = document.getElementById("loginMsg");
  const btnLogin = document.getElementById("btnLogin");
  const btnLoginLater = document.getElementById("btnLoginLater");
  const btnResetPass = document.getElementById("btnResetPass");

  /******************************************************************
   * 2) HELPERS
   ******************************************************************/
  const pad2 = (n) => String(n).padStart(2, "0");

  function fmtDate(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function fmtTime(ts){
    const d = new Date(ts);
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  function fmtDateTime(ts){ return `${fmtDate(ts)} ${fmtTime(ts)}`; }

  function todayKey(){ return fmtDate(Date.now()); }

  function minutesDiff(aTs, bTs){
    if(aTs == null || bTs == null) return null;
    if(bTs < aTs) return null;
    return Math.floor((bTs - aTs) / 60000);
  }
  function hm(min){
    if(min == null) return "";
    const h = Math.floor(min/60);
    const m = min%60;
    return `${h} h ${pad2(m)} m`;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  function dtLocalValue(ts){
    const d = new Date(ts);
    const yyyy = d.getFullYear();
    const mm = pad2(d.getMonth()+1);
    const dd = pad2(d.getDate());
    const hh = pad2(d.getHours());
    const mi = pad2(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }

  function monthKeyDefault(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  }

  function setStatus(msg){
    elStatusText.textContent = "Stav: " + msg;
  }

  function setSyncBadge({state, text}){
    elSyncDot.classList.remove("ok","warn","bad");
    if(state === "ok") elSyncDot.classList.add("ok");
    if(state === "warn") elSyncDot.classList.add("warn");
    if(state === "bad") elSyncDot.classList.add("bad");
    elSyncText.textContent = text;
  }

  function lockUI(lock){
    btnShiftStart.disabled = lock;
    btnShiftEnd.disabled = lock;
    btnStoreIn.disabled = lock;
    btnStoreOut.disabled = lock;
    btnExport.disabled = lock;
    inpStore.disabled = lock;
    monthPick.disabled = lock;
  }

  /******************************************************************
   * 3) MODALS / DRAWER
   ******************************************************************/
  function confirmAction(message){
    return new Promise((resolve) => {
      modalMsg.textContent = message;
      modalBack.style.display = "flex";
      modalBack.setAttribute("aria-hidden","false");
      modalBack.style.zIndex = "10000";

      const cleanup = () => {
        modalBack.style.display = "none";
        modalBack.setAttribute("aria-hidden","true");
        modalBack.style.zIndex = "";
        modalYes.onclick = null;
        modalNo.onclick = null;
        modalBack.onclick = null;
      };

      modalYes.onclick = () => { cleanup(); resolve(true); };
      modalNo.onclick  = () => { cleanup(); resolve(false); };
      modalBack.onclick = (e) => { if(e.target === modalBack){ cleanup(); resolve(false); } };
    });
  }

  function openDrawer(){
    drawerBack.style.display = "block";
    drawerBack.setAttribute("aria-hidden","false");
  }
  function closeDrawer(){
    drawerBack.style.display = "none";
    drawerBack.setAttribute("aria-hidden","true");
  }

  function openForm({title, bodyHtml, buttons}){
    formTitle.textContent = title;
    formBody.innerHTML = bodyHtml;
    formActions.innerHTML = "";

    buttons.forEach(b => {
      const btn = document.createElement("button");
      btn.className = b.cls || "";
      btn.textContent = b.text;
      btn.onclick = async () => { await b.onClick?.(); };
      formActions.appendChild(btn);
    });

    formBack.style.display = "flex";
    formBack.setAttribute("aria-hidden","false");

    formBack.onclick = (e) => { if(e.target === formBack) closeForm(); };
  }
  function closeForm(){
    formBack.style.display = "none";
    formBack.setAttribute("aria-hidden","true");
    formBack.onclick = null;
  }
  function $id(id){ return document.getElementById(id); }

  function showLoginOverlay(show){
    loginBack.style.display = show ? "flex" : "none";
    loginBack.setAttribute("aria-hidden", show ? "false" : "true");
    loginMsg.classList.add("hidden");
    loginMsg.textContent = "";
  }

  /******************************************************************
   * 4) GEO
   ******************************************************************/
  function getGeo(){
    return new Promise((resolve) => {
      if(!navigator.geolocation){
        resolve({ ok:false, err:"Geolocation nen√≠ podporovan√Ω." });
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({
          ok:true,
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          acc: pos.coords.accuracy
        }),
        (err) => resolve({ ok:false, err: err?.message || "GPS chyba" }),
        { enableHighAccuracy:true, timeout: 12000, maximumAge: 0 }
      );
    });
  }

  async function capturePoint(){
    const ts = Date.now();
    const geo = await getGeo();
    return {
      ts,
      lat: geo.ok ? geo.lat : null,
      lon: geo.ok ? geo.lon : null,
      acc: geo.ok ? geo.acc : null,
      geoOk: geo.ok,
      geoErr: geo.ok ? null : geo.err
    };
  }

  function gpsText(p){
    const has = (p?.lat != null && p?.lon != null);
    if(!has) return "bez GPS";
    const acc = (p.acc != null) ? `¬±${Math.round(p.acc)}m` : "¬±?";
    return `${p.lat.toFixed(6)}, ${p.lon.toFixed(6)} (${acc})`;
  }

  /******************************************************************
   * 5) AUTH (Supabase)
   ******************************************************************/
  async function signIn(email, password){
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) throw error;
    return data;
  }

  async function signOut(){
    const { error } = await supabase.auth.signOut();
    if(error) throw error;
  }

  async function getUser(){
    const { data } = await supabase.auth.getUser();
    return data?.user || null;
  }

  async function ensureAuthUI(){
    const user = await getUser();
    if(user){
      accountLabel.textContent = user.email || "P≈ôihl√°≈°en";
      accountChip.textContent = "logout";
      showLoginOverlay(false);
    }else{
      accountLabel.textContent = "Nep≈ôihl√°≈°en";
      accountChip.textContent = "login";
    }
    return user;
  }

  /******************************************************************
   * 6) ONLINE + OFFLINE QUEUE (Outbox)
   ******************************************************************/
  const OUTBOX_KEY = "merch_outbox_v1";
  const LOCAL_CACHE_KEY = "merch_cache_events_v1";
  const LOCAL_CACHE_MAX = 2000;

  function outboxLoad(){
    try{
      const raw = localStorage.getItem(OUTBOX_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function outboxSave(arr){ localStorage.setItem(OUTBOX_KEY, JSON.stringify(arr)); }

  function cacheLoad(){
    try{
      const raw = localStorage.getItem(LOCAL_CACHE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function cacheSave(arr){
    const sliced = arr.slice(-LOCAL_CACHE_MAX);
    localStorage.setItem(LOCAL_CACHE_KEY, JSON.stringify(sliced));
  }

  function uuid(){
    return (crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2)));
  }

  function buildEventRow({kind, ts, session_id=null, store_name=null, lat=null, lon=null, acc=null, payload={}}){
    const iso = new Date(ts).toISOString();
    const day = iso.slice(0,10);
    return {
      client_event_id: uuid(),
      kind,
      ts: iso,
      day,
      session_id,
      store_name,
      lat, lon, acc,
      payload
    };
  }

  async function pushEventToSupabase(row){
    const user = await getUser();
    if(!user) throw new Error("NOT_SIGNED_IN");

    const insertRow = {
      user_id: user.id,
      user_email: user.email,
      kind: row.kind,
      ts: row.ts,
      day: row.day,
      session_id: row.session_id,
      store_name: row.store_name,
      lat: row.lat,
      lon: row.lon,
      acc: row.acc,
      payload: row.payload || {}
    };

    const { error } = await supabase.from("attendance_events").insert(insertRow);
    if(error) throw error;
  }

  async function queueAndTrySend(row){
    const ob = outboxLoad();
    ob.push(row);
    outboxSave(ob);

    const cache = cacheLoad();
    cache.push(row);
    cacheSave(cache);

    try{
      await pushEventToSupabase(row);
      const ob2 = outboxLoad().filter(x => x.client_event_id !== row.client_event_id);
      outboxSave(ob2);
      setSyncBadge({state:"ok", text: ob2.length ? `sync: ${ob2.length} ƒçek√°` : "sync: ok"});
    }catch(e){
      const ob3 = outboxLoad();
      setSyncBadge({state:navigator.onLine ? "warn" : "bad", text: `ƒçek√°: ${ob3.length}`});
      throw e;
    }
  }

  async function syncOutbox(){
    const user = await getUser();
    const ob = outboxLoad();
    if(!ob.length){
      setSyncBadge({state: navigator.onLine ? "ok" : "bad", text: navigator.onLine ? "sync: ok" : "offline"});
      return;
    }
    if(!user){
      setSyncBadge({state:"warn", text:`ƒçek√°: ${ob.length} (bez loginu)`});
      return;
    }
    if(!navigator.onLine){
      setSyncBadge({state:"bad", text:`offline (ƒçek√°: ${ob.length})`});
      return;
    }

    let sent = 0;
    const remaining = [];
    for(const row of ob){
      try{
        await pushEventToSupabase(row);
        sent++;
      }catch(e){
        remaining.push(row);
      }
    }
    outboxSave(remaining);
    setSyncBadge({state: remaining.length ? "warn" : "ok", text: remaining.length ? `ƒçek√°: ${remaining.length}` : `sync: ok`});
    if(sent) setStatus(`odesl√°no ${sent} z√°znam≈Ø ‚úÖ`);
  }

  /******************************************************************
   * 7) FETCH Z CLOUDU
   ******************************************************************/
  async function fetchMonthEvents(year, month1to12){
    const user = await getUser();
    if(!user) throw new Error("NOT_SIGNED_IN");

    const from = new Date(year, month1to12-1, 1, 0,0,0,0).toISOString();
    const to = new Date(year, month1to12, 1, 0,0,0,0).toISOString();

    const { data, error } = await supabase
      .from("attendance_events")
      .select("*")
      .gte("ts", from)
      .lt("ts", to)
      .order("ts", { ascending: true });

    if(error) throw error;
    return data || [];
  }

  async function fetchTodayEvents(){
    const user = await getUser();
    if(!user) return [];
    const dk = todayKey();
    const from = new Date(dk + "T00:00:00").toISOString();
    const to = new Date(dk + "T23:59:59.999").toISOString();

    const { data, error } = await supabase
      .from("attendance_events")
      .select("*")
      .gte("ts", from)
      .lte("ts", to)
      .order("ts", { ascending: true });

    if(error) throw error;
    return data || [];
  }

  /******************************************************************
   * 8) DOM√âNOV√Å LOGIKA
   ******************************************************************/
  function normalizeRow(r){
    return {
      id: r.id || r.client_event_id || uuid(),
      kind: r.kind,
      ts: (typeof r.ts === "string") ? r.ts : new Date(r.ts).toISOString(),
      day: r.day || (typeof r.ts === "string" ? r.ts.slice(0,10) : fmtDate(r.ts)),
      session_id: r.session_id || null,
      store_name: r.store_name || null,
      lat: (r.lat ?? r.latitude ?? null),
      lon: (r.lon ?? r.longitude ?? null),
      acc: (r.acc ?? r.accuracy ?? null),
      payload: r.payload || {}
    };
  }

  function deriveTodayStateFromEvents(rows){
    const events = rows.map(normalizeRow).filter(r => r.day === todayKey()).sort((a,b)=>a.ts.localeCompare(b.ts));

    const sessions = new Map();
    const trainings = [];
    const sickness = [];
    let vacation = false;

    for(const e of events){
      if(e.kind === "SHIFT_START"){
        const sid = e.session_id || uuid();
        if(!sessions.has(sid)) sessions.set(sid, { session_id: sid, start: e, end: null, visits: [] });
      }
      if(e.kind === "SHIFT_END"){
        const sid = e.session_id;
        if(sid && sessions.has(sid)) sessions.get(sid).end = e;
      }
      if(e.kind === "STORE_IN"){
        const sid = e.session_id;
        const vid = e.payload?.visit_id || uuid();
        const rec = { visit_id: vid, store_name: e.store_name || e.payload?.store_name || "", in: e, out: null };
        if(sid){
          if(!sessions.has(sid)) sessions.set(sid, { session_id: sid, start: null, end: null, visits: [] });
          sessions.get(sid).visits.push(rec);
        }
      }
      if(e.kind === "STORE_OUT"){
        const sid = e.session_id;
        const vid = e.payload?.visit_id;
        if(sid && vid && sessions.has(sid)){
          const s = sessions.get(sid);
          const v = [...s.visits].reverse().find(x => x.visit_id === vid && !x.out);
          if(v) v.out = e;
        }
      }
      if(e.kind === "TRAINING") trainings.push(e);
      if(e.kind === "SICK") sickness.push(e);
      if(e.kind === "VACATION") vacation = true;
    }

    const sessArr = Array.from(sessions.values()).sort((a,b)=>{
      const ats = a.start?.ts || "";
      const bts = b.start?.ts || "";
      return ats.localeCompare(bts);
    });

    const activeSession = [...sessArr].reverse().find(s => s.start && !s.end) || null;
    let activeVisit = null;
    if(activeSession){
      activeVisit = [...activeSession.visits].reverse().find(v => v.in && !v.out) || null;
    }

    return { events, sessions: sessArr, activeSession, activeVisit, trainings, sickness, vacation };
  }

  /******************************************************************
   * 9) AKCE (logov√°n√≠)
   ******************************************************************/
  async function startShift(){
    const ok = await confirmAction("P≈ôejete si potvrdit p≈ô√≠chod do pr√°ce?");
    if(!ok) return;

    const st = deriveTodayStateFromEvents(cacheLoad());
    if(st.activeSession){
      setStatus("smƒõna u≈æ bƒõ≈æ√≠ (nejd≈ô√≠v dej odchod).");
      render();
      return;
    }

    lockUI(true);
    setStatus("ukl√°d√°m p≈ô√≠chod‚Ä¶");

    const p = await capturePoint();
    const session_id = uuid();

    const row = buildEventRow({
      kind: "SHIFT_START",
      ts: p.ts,
      session_id,
      lat: p.lat, lon: p.lon, acc: p.acc,
      payload: { app_version: "supabase_v1" }
    });

    try{
      await queueAndTrySend(row);
      setStatus(p.geoOk ? "p≈ô√≠chod ulo≈æen ‚úÖ (s GPS)" : `p≈ô√≠chod ulo≈æen ‚úÖ (bez GPS: ${p.geoErr})`);
    }catch(e){
      setStatus("ulo≈æeno offline do fronty ‚úÖ");
    }finally{
      lockUI(false);
      render();
    }
  }

  async function endShift(){
    const ok = await confirmAction("P≈ôejete si potvrdit odchod z pr√°ce?");
    if(!ok) return;

    const st = deriveTodayStateFromEvents(cacheLoad());
    const s = st.activeSession;
    if(!s){
      setStatus("≈æ√°dn√° smƒõna nebƒõ≈æ√≠.");
      render();
      return;
    }
    if(st.activeVisit){
      alert("Nejd≈ô√≠v ukonƒçi n√°v≈°tƒõvu prodejny (odchod z prodejny).");
      return;
    }

    lockUI(true);
    setStatus("ukl√°d√°m odchod‚Ä¶");

    const p = await capturePoint();

    const row = buildEventRow({
      kind: "SHIFT_END",
      ts: p.ts,
      session_id: s.session_id,
      lat: p.lat, lon: p.lon, acc: p.acc,
      payload: { app_version: "supabase_v1" }
    });

    try{
      await queueAndTrySend(row);
      const workMin = minutesDiff(Date.parse(s.start.ts), p.ts);
      setStatus(p.geoOk ? `odchod ulo≈æen ‚úÖ (celkem ${hm(workMin)})` : `odchod ulo≈æen ‚úÖ (bez GPS: ${p.geoErr})`);
    }catch(e){
      setStatus("ulo≈æeno offline do fronty ‚úÖ");
    }finally{
      lockUI(false);
      render();
    }
  }

  async function storeIn(){
    const name = (inpStore.value || "").trim();
    if(!name){
      alert("Zadej n√°zev prodejny.");
      inpStore.focus();
      return;
    }

    const st = deriveTodayStateFromEvents(cacheLoad());
    const s = st.activeSession;
    if(!s){
      alert("Nejd≈ô√≠v zahaj smƒõnu (P≈ô√≠chod).");
      return;
    }
    if(st.activeVisit){
      alert("U≈æ m√°≈° aktivn√≠ n√°v≈°tƒõvu. Nejd≈ô√≠v dej odchod z prodejny.");
      return;
    }

    const ok = await confirmAction(`P≈ôejete si potvrdit VSTUP na prodejnu?\n\nProdejna: ${name}`);
    if(!ok) return;

    lockUI(true);
    setStatus("ukl√°d√°m vstup na prodejnu‚Ä¶");

    const p = await capturePoint();
    const visit_id = uuid();

    const row = buildEventRow({
      kind: "STORE_IN",
      ts: p.ts,
      session_id: s.session_id,
      store_name: name,
      lat: p.lat, lon: p.lon, acc: p.acc,
      payload: { visit_id, store_name: name }
    });

    try{
      await queueAndTrySend(row);
      setStatus(p.geoOk ? "vstup ulo≈æen ‚úÖ (s GPS)" : `vstup ulo≈æen ‚úÖ (bez GPS: ${p.geoErr})`);
    }catch(e){
      setStatus("ulo≈æeno offline do fronty ‚úÖ");
    }finally{
      lockUI(false);
      render();
    }
  }

  async function storeOut(){
    const st = deriveTodayStateFromEvents(cacheLoad());
    const s = st.activeSession;
    const v = st.activeVisit;

    if(!s){
      alert("Nejd≈ô√≠v zahaj smƒõnu (P≈ô√≠chod).");
      return;
    }
    if(!v){
      alert("≈Ω√°dn√° aktivn√≠ n√°v≈°tƒõva nen√≠ otev≈ôen√°.");
      return;
    }

    const storeName = v.store_name || v.in.store_name || "(bez n√°zvu)";
    const ok = await confirmAction(`P≈ôejete si potvrdit ODCHOD z prodejny?\n\nProdejna: ${storeName}`);
    if(!ok) return;

    lockUI(true);
    setStatus("ukl√°d√°m odchod z prodejny‚Ä¶");

    const p = await capturePoint();

    const row = buildEventRow({
      kind: "STORE_OUT",
      ts: p.ts,
      session_id: s.session_id,
      store_name: storeName,
      lat: p.lat, lon: p.lon, acc: p.acc,
      payload: { visit_id: v.visit_id, store_name: storeName }
    });

    try{
      await queueAndTrySend(row);
      const vMin = minutesDiff(Date.parse(v.in.ts), p.ts);
      setStatus(p.geoOk ? `odchod ulo≈æen ‚úÖ (n√°v≈°tƒõva ${hm(vMin)})` : `odchod ulo≈æen ‚úÖ (bez GPS: ${p.geoErr})`);
    }catch(e){
      setStatus("ulo≈æeno offline do fronty ‚úÖ");
    }finally{
      lockUI(false);
      render();
    }
  }

  /******************************************************************
   * 10) MENU FUNKCE
   ******************************************************************/
  function openTrainingForm(){
    closeDrawer();
    const now = Date.now();
    const startDefault = dtLocalValue(now);
    const endDefault = dtLocalValue(now + 60*60000);

    openForm({
      title: "≈†kolen√≠ (placen√©)",
      bodyHtml: `
        <div class="space-y-3">
          <label class="block text-[11px] font-extrabold tracking-widest text-slate-400 uppercase">Od</label>
          <input class="w-full rounded-2xl px-4 py-4 bg-slate-950/35 border border-slate-400/15 text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500/35 focus:border-indigo-300/25"
            type="datetime-local" id="trStart" value="${startDefault}">
          <label class="block text-[11px] font-extrabold tracking-widest text-slate-400 uppercase">Do</label>
          <input class="w-full rounded-2xl px-4 py-4 bg-slate-950/35 border border-slate-400/15 text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500/35 focus:border-indigo-300/25"
            type="datetime-local" id="trEnd" value="${endDefault}">
          <div class="text-[11px] text-slate-400">Ulo≈æ√≠ se jako placen√© ≈°kolen√≠ (event TRAINING).</div>
        </div>
      `,
      buttons: [
        { text:"Ulo≈æit", cls:"flex-1 rounded-2xl py-3 font-black tracking-widest bg-emerald-500/20 border border-emerald-300/20 btn-glow-green active:scale-[.99] transition",
          onClick: async () => {
            const ok = await confirmAction("Potvrdit ulo≈æen√≠ ≈°kolen√≠?");
            if(!ok) return;

            const s = $id("trStart").value;
            const e = $id("trEnd").value;
            const startTs = Date.parse(s);
            const endTs = Date.parse(e);

            if(!Number.isFinite(startTs) || !Number.isFinite(endTs) || endTs <= startTs){
              alert("Neplatn√Ω ƒçasov√Ω rozsah.");
              return;
            }

            const minutes = minutesDiff(startTs, endTs) ?? 0;
            const row = buildEventRow({
              kind: "TRAINING",
              ts: startTs,
              payload: { start_ts: new Date(startTs).toISOString(), end_ts: new Date(endTs).toISOString(), minutes }
            });

            lockUI(true);
            try{
              await queueAndTrySend(row);
              setStatus("≈°kolen√≠ ulo≈æeno ‚úÖ");
            }catch{
              setStatus("≈°kolen√≠ ulo≈æeno offline do fronty ‚úÖ");
            }finally{
              lockUI(false);
              closeForm();
              render();
            }
          }
        },
        { text:"Zru≈°it", cls:"flex-1 rounded-2xl py-3 font-black tracking-widest bg-rose-500/18 border border-rose-300/20 btn-glow-red active:scale-[.99] transition",
          onClick: async () => closeForm()
        }
      ]
    });
  }

  function openSickForm(){
    closeDrawer();
    const now = Date.now();
    const startDefault = dtLocalValue(now);
    const endDefault = dtLocalValue(now + 8*60*60000);

    openForm({
      title: "Nemoc (neplacen√°)",
      bodyHtml: `
        <div class="space-y-3">
          <label class="block text-[11px] font-extrabold tracking-widest text-slate-400 uppercase">Od</label>
          <input class="w-full rounded-2xl px-4 py-4 bg-slate-950/35 border border-slate-400/15 text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500/35 focus:border-indigo-300/25"
            type="datetime-local" id="siStart" value="${startDefault}">
          <label class="block text-[11px] font-extrabold tracking-widest text-slate-400 uppercase">Do</label>
          <input class="w-full rounded-2xl px-4 py-4 bg-slate-950/35 border border-slate-400/15 text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500/35 focus:border-indigo-300/25"
            type="datetime-local" id="siEnd" value="${endDefault}">
          <div class="text-[11px] text-slate-400">Ulo≈æ√≠ se jako event SICK (neplacen√©).</div>
        </div>
      `,
      buttons: [
        { text:"Ulo≈æit", cls:"flex-1 rounded-2xl py-3 font-black tracking-widest bg-emerald-500/20 border border-emerald-300/20 btn-glow-green active:scale-[.99] transition",
          onClick: async () => {
            const ok = await confirmAction("Potvrdit ulo≈æen√≠ nemoci?");
            if(!ok) return;

            const s = $id("siStart").value;
            const e = $id("siEnd").value;
            const startTs = Date.parse(s);
            const endTs = Date.parse(e);

            if(!Number.isFinite(startTs) || !Number.isFinite(endTs) || endTs <= startTs){
              alert("Neplatn√Ω ƒçasov√Ω rozsah.");
              return;
            }

            const minutes = minutesDiff(startTs, endTs) ?? 0;
            const row = buildEventRow({
              kind: "SICK",
              ts: startTs,
              payload: { start_ts: new Date(startTs).toISOString(), end_ts: new Date(endTs).toISOString(), minutes }
            });

            lockUI(true);
            try{
              await queueAndTrySend(row);
              setStatus("nemoc ulo≈æena ‚úÖ");
            }catch{
              setStatus("nemoc ulo≈æena offline do fronty ‚úÖ");
            }finally{
              lockUI(false);
              closeForm();
              render();
            }
          }
        },
        { text:"Zru≈°it", cls:"flex-1 rounded-2xl py-3 font-black tracking-widest bg-rose-500/18 border border-rose-300/20 btn-glow-red active:scale-[.99] transition",
          onClick: async () => closeForm()
        }
      ]
    });
  }

  function openVacationForm(){
    closeDrawer();
    const dk = todayKey();

    openForm({
      title: "Dovolen√°",
      bodyHtml: `
        <div class="space-y-3">
          <label class="block text-[11px] font-extrabold tracking-widest text-slate-400 uppercase">Vyber den</label>
          <input class="w-full rounded-2xl px-4 py-4 bg-slate-950/35 border border-slate-400/15 text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500/35 focus:border-indigo-300/25"
            type="date" id="vacDay" value="${dk}">
          <div class="text-[11px] text-slate-400">P≈ôid√° se event VACATION (8 hodin v reportu).</div>
        </div>
      `,
      buttons: [
        { text:"P≈ôidat", cls:"flex-1 rounded-2xl py-3 font-black tracking-widest bg-emerald-500/20 border border-emerald-300/20 btn-glow-green active:scale-[.99] transition",
          onClick: async () => {
            const day = $id("vacDay").value;
            if(!day){ alert("Vyber den."); return; }
            const ok = await confirmAction(`P≈ôidat dovolenou pro den ${day}?`);
            if(!ok) return;

            const ts = Date.parse(day + "T00:00:00");
            const row = buildEventRow({
              kind: "VACATION",
              ts,
              payload: { day, minutes: 480 }
            });

            lockUI(true);
            try{
              await queueAndTrySend(row);
              setStatus("dovolen√° ulo≈æena ‚úÖ");
            }catch{
              setStatus("dovolen√° ulo≈æena offline do fronty ‚úÖ");
            }finally{
              lockUI(false);
              closeForm();
              render();
            }
          }
        },
        { text:"Zru≈°it", cls:"flex-1 rounded-2xl py-3 font-black tracking-widest bg-rose-500/18 border border-rose-300/20 btn-glow-red active:scale-[.99] transition",
          onClick: async () => closeForm()
        }
      ]
    });
  }

  /******************************************************************
   * 11) EXPORT (CSV)
   ******************************************************************/
  function parseMonthValue(v){
    if(!v) return null;
    const [y,m] = v.split("-").map(Number);
    if(!y || !m) return null;
    return { y, m };
  }
  function csvEscape(value, sep){
    const s = String(value ?? "");
    const needs = s.includes(sep) || s.includes('"') || s.includes("\n");
    const v = s.replaceAll('"','""');
    return needs ? `"${v}"` : v;
  }

  function groupByDay(rows){
    const by = new Map();
    rows.forEach(r => {
      const e = normalizeRow(r);
      const day = e.day;
      if(!by.has(day)) by.set(day, []);
      by.get(day).push(e);
    });
    for(const arr of by.values()){
      arr.sort((a,b)=>a.ts.localeCompare(b.ts));
    }
    return by;
  }

  function computeDayTotals(dayRows){
    const sessions = new Map();
    let trainingMin = 0;
    let sickMin = 0;
    let vacationMin = 0;
    let visits = 0;

    for(const e of dayRows){
      if(e.kind === "SHIFT_START"){
        const sid = e.session_id;
        if(sid && !sessions.has(sid)) sessions.set(sid, { start: e, end: null });
      }
      if(e.kind === "SHIFT_END"){
        const sid = e.session_id;
        if(sid){
          if(!sessions.has(sid)) sessions.set(sid, { start: null, end: e });
          else sessions.get(sid).end = e;
        }
      }
      if(e.kind === "STORE_IN") visits++;
      if(e.kind === "TRAINING") trainingMin += (e.payload?.minutes ?? 0);
      if(e.kind === "SICK") sickMin += (e.payload?.minutes ?? 0);
      if(e.kind === "VACATION") vacationMin = 480;
    }

    let workMin = 0;
    for(const s of sessions.values()){
      if(s.start && s.end){
        const m = minutesDiff(Date.parse(s.start.ts), Date.parse(s.end.ts));
        if(m != null) workMin += m;
      }
    }

    const paidMin = workMin + trainingMin + vacationMin;
    return { workMin, trainingMin, sickMin, vacationMin, paidMin, visits };
  }

  async function exportCsv(){
    const sel = parseMonthValue(monthPick.value);
    if(!sel){ alert("Vyber mƒõs√≠c pro export."); return; }

    lockUI(true);
    setStatus("p≈ôipravuju export‚Ä¶");

    let rows = [];
    try{
      const user = await getUser();
      if(user){
        rows = await fetchMonthEvents(sel.y, sel.m);
      }else{
        const all = cacheLoad().map(normalizeRow);
        rows = all.filter(r => {
          const d = new Date(r.ts);
          return d.getFullYear() === sel.y && (d.getMonth()+1) === sel.m;
        });
      }
    }catch(e){
      alert("Export selhal: " + (e?.message || e));
      lockUI(false);
      return;
    }

    const byDay = groupByDay(rows);
    const sep = ",";
    const head = [
      "row_type","date",
      "work_minutes","training_minutes","vacation_minutes","sick_minutes","paid_minutes",
      "visit_count",
      "kind","ts","session_id","store_name",
      "lat","lon","acc",
      "payload_json"
    ];
    const lines = [head.join(sep)];

    const days = Array.from(byDay.keys()).sort((a,b)=>a.localeCompare(b));
    for(const day of days){
      const dayRows = byDay.get(day);
      const t = computeDayTotals(dayRows);

      lines.push([
        "DAY_TOTAL", day,
        t.workMin, t.trainingMin, t.vacationMin, t.sickMin, t.paidMin,
        t.visits,
        "", "", "", "",
        "", "", "",
        ""
      ].map(x=>csvEscape(x, sep)).join(sep));

      for(const e of dayRows){
        lines.push([
          "EVENT", day,
          "", "", "", "", "",
          "",
          e.kind, e.ts, e.session_id || "", e.store_name || "",
          e.lat ?? "", e.lon ?? "", e.acc ?? "",
          JSON.stringify(e.payload || {})
        ].map(x=>csvEscape(x, sep)).join(sep));
      }
    }

    const csv = "\uFEFF" + lines.join("\n");
    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const fname = `merchandiser_log_${sel.y}_${pad2(sel.m)}.csv`;
    const a = document.createElement("a");
    a.href = url;
    a.download = fname;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    lockUI(false);
    setStatus("export hotovej ‚úÖ");
  }

  /******************************************************************
   * 12) RENDER
   ******************************************************************/
  function updateNow(){
    const d = new Date();
    elNow.textContent = `${d.getDate()}. ${d.getMonth()+1}. ${d.getFullYear()}  ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  function render(){
    updateNow();

    const ob = outboxLoad();
    if(!navigator.onLine){
      setSyncBadge({state:"bad", text: `offline (ƒçek√°: ${ob.length})`});
    }else{
      setSyncBadge({state: ob.length ? "warn" : "ok", text: ob.length ? `ƒçek√°: ${ob.length}` : "sync: ok"});
    }

    const st = deriveTodayStateFromEvents(cacheLoad());

    if(!st.activeSession) elPill.textContent = "MIMO PRACOVN√ç DOBU";
    else if(st.activeSession && st.activeVisit) elPill.textContent = "NA PRODEJNƒö";
    else elPill.textContent = "VE SMƒöNƒö";

    btnShiftStart.disabled = !!st.activeSession;
    btnShiftEnd.disabled = !st.activeSession;

    btnStoreIn.disabled = !st.activeSession || !!st.activeVisit;
    btnStoreOut.disabled = !st.activeSession || !st.activeVisit;

    if(!monthPick.value) monthPick.value = monthKeyDefault();

    const items = [];

    for(let i=0; i<st.sessions.length; i++){
      const s = st.sessions[i];
      if(s.start){
        items.push({
          tag:`SMƒöNA #${i+1}`,
          title:"P≈ô√≠chod",
          sub:`${fmtDateTime(Date.parse(s.start.ts))} ‚Ä¢ GPS: ${gpsText(s.start)}`
        });
      }
      for(let j=0; j<s.visits.length; j++){
        const v = s.visits[j];
        const inTs = Date.parse(v.in.ts);
        const outTs = v.out ? Date.parse(v.out.ts) : null;
        const dur = outTs ? hm(minutesDiff(inTs, outTs)) : "prob√≠h√°‚Ä¶";
        items.push({
          tag:`PRODEJNA ${i+1}.${j+1}`,
          title: v.store_name || "(bez n√°zvu)",
          sub:`${fmtDateTime(inTs)} ‚Üí ${outTs ? fmtDateTime(outTs) : "‚Äî"} ‚Ä¢ ${dur}`
        });
      }
      if(s.end){
        const w = minutesDiff(Date.parse(s.start.ts), Date.parse(s.end.ts));
        items.push({
          tag:`SMƒöNA #${i+1}`,
          title:"Odchod",
          sub:`${fmtDateTime(Date.parse(s.end.ts))} ‚Ä¢ Celkem: ${hm(w)}`
        });
      }else if(s.start){
        items.push({
          tag:`SMƒöNA #${i+1}`,
          title:"Bƒõ≈æ√≠‚Ä¶",
          sub:"Smƒõna nen√≠ uzav≈ôen√° (ƒçek√° na Odchod)."
        });
      }
    }

    for(const e of st.trainings){
      items.push({
        tag:"≈†KOLEN√ç",
        title:"≈†kolen√≠ (placen√©)",
        sub:`${e.payload?.start_ts || e.ts} ‚Üí ${e.payload?.end_ts || ""} ‚Ä¢ ${hm(e.payload?.minutes || 0)}`
      });
    }
    for(const e of st.sickness){
      items.push({
        tag:"NEMOC",
        title:"Nemoc (neplacen√°)",
        sub:`${e.payload?.start_ts || e.ts} ‚Üí ${e.payload?.end_ts || ""} ‚Ä¢ ${hm(e.payload?.minutes || 0)}`
      });
    }
    if(st.vacation){
      items.push({ tag:"DOVOLEN√Å", title:"Dovolen√°", sub:"Cel√Ω den (8 hodin)" });
    }

    if(!items.length){
      elActivity.innerHTML = `
        <div class="glass-soft rounded-2xl px-4 py-4 border border-slate-400/10 text-slate-400 text-sm">
          Zat√≠m nic. Klikni na P≈ò√çCHOD.
        </div>
      `;
    }else{
      elActivity.innerHTML = items.map(it => `
        <div class="glass-soft rounded-2xl px-4 py-4 border border-slate-400/10">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-sm font-black tracking-wide text-slate-100">${escapeHtml(it.title)}</div>
              <div class="mt-1 text-[12px] text-slate-400 font-semibold whitespace-pre-wrap">${escapeHtml(it.sub)}</div>
            </div>
            <div class="text-[11px] font-extrabold tracking-widest px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-300/10 text-indigo-200 whitespace-nowrap">
              ${escapeHtml(it.tag)}
            </div>
          </div>
        </div>
      `).join("");
    }
  }

  /******************************************************************
   * 13) MENU / SERVIS AKCE
   ******************************************************************/
  async function handleAccountClick(){
    closeDrawer();
    const user = await getUser();
    if(user){
      const ok = await confirmAction("Odhl√°sit se?");
      if(!ok) return;
      await signOut();
      await ensureAuthUI();
      setStatus("odhl√°≈°eno");
      render();
      return;
    }
    showLoginOverlay(true);
  }

  async function clearTodayLocal(){
    closeDrawer();
    const ok = await confirmAction("Vymazat dne≈°n√≠ lok√°ln√≠ cache? (cloud data z≈Øst√°vaj√≠)");
    if(!ok) return;
    const dk = todayKey();
    const cache = cacheLoad().map(normalizeRow).filter(r => r.day !== dk);
    cacheSave(cache);
    const ob = outboxLoad().filter(r => (normalizeRow(r).day !== dk));
    outboxSave(ob);
    setStatus("dne≈°ek vymaz√°n lok√°lnƒõ üßº");
    render();
  }

  async function clearAllLocal(){
    closeDrawer();
    const ok = await confirmAction("Vymazat ve≈°ker√° lok√°ln√≠ data? (cloud data z≈Øst√°vaj√≠)");
    if(!ok) return;
    localStorage.removeItem(LOCAL_CACHE_KEY);
    localStorage.removeItem(OUTBOX_KEY);
    setStatus("lok√°ln√≠ data vymaz√°na üßº");
    render();
  }

  /******************************************************************
   * 14) LOGIN HANDLERS
   ******************************************************************/
  btnLogin.addEventListener("click", async () => {
    loginMsg.classList.add("hidden");
    const email = (loginEmail.value || "").trim();
    const pass = (loginPass.value || ""); // ‚úÖ NEtrimovat heslo
    if(!email || !pass){
      loginMsg.textContent = "Zadej email a heslo.";
      loginMsg.classList.remove("hidden");
      return;
    }
    btnLogin.disabled = true;
    try{
      await signIn(email, pass);
      await ensureAuthUI();
      showLoginOverlay(false);
      setStatus("p≈ôihl√°≈°eno ‚úÖ");
      await syncOutbox();
    }catch(e){
      loginMsg.textContent = "P≈ôihl√°≈°en√≠ selhalo: " + (e?.message || e);
      loginMsg.classList.remove("hidden");
    }finally{
      btnLogin.disabled = false;
      render();
    }
  });

  btnResetPass.addEventListener("click", async () => {
    loginMsg.classList.add("hidden");

    const email = (loginEmail.value || "").trim();
    if(!email){
      loginMsg.textContent = "Zadej email pro reset hesla.";
      loginMsg.classList.remove("hidden");
      return;
    }

    btnResetPass.disabled = true;
    try{
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: "https://pavelsukup-netizen.github.io/dochazka/"
      });
      if(error) throw error;

      loginMsg.textContent = "Hotovo ‚úÖ Koukej do emailu (Reset password) a klikni na odkaz.";
      loginMsg.classList.remove("hidden");
    }catch(e){
      loginMsg.textContent = "Reset selhal: " + (e?.message || e);
      loginMsg.classList.remove("hidden");
    }finally{
      btnResetPass.disabled = false;
    }
  });

  btnLoginLater.addEventListener("click", () => {
    showLoginOverlay(false);
  });

  /******************************************************************
   * 15) WIRE-UP
   ******************************************************************/
  btnShiftStart.addEventListener("click", startShift);
  btnShiftEnd.addEventListener("click", endShift);
  btnStoreIn.addEventListener("click", storeIn);
  btnStoreOut.addEventListener("click", storeOut);
  btnExport.addEventListener("click", exportCsv);

  btnHamb.addEventListener("click", openDrawer);
  drawerClose.addEventListener("click", closeDrawer);
  drawerBack.addEventListener("click", (e) => { if(e.target === drawerBack) closeDrawer(); });

  btnTraining.addEventListener("click", openTrainingForm);
  btnSick.addEventListener("click", openSickForm);
  btnVacation.addEventListener("click", openVacationForm);

  btnAccount.addEventListener("click", handleAccountClick);
  btnSyncNow.addEventListener("click", async () => { closeDrawer(); await syncOutbox(); render(); });
  btnClearToday.addEventListener("click", clearTodayLocal);
  btnClearAllLocal.addEventListener("click", clearAllLocal);

  window.addEventListener("online", () => { syncOutbox().catch(()=>{}); render(); });
  window.addEventListener("offline", () => { render(); });

  supabase.auth.onAuthStateChange((_event, _session) => {
    ensureAuthUI().then(()=>{ render(); syncOutbox().catch(()=>{}); });
  });

  /******************************************************************
   * 16) INIT
   ******************************************************************/
  (async () => {
    if(SUPABASE_URL.includes("PASTE_") || SUPABASE_ANON_KEY.includes("PASTE_")){
      setStatus("Dopl≈à SUPABASE_URL a SUPABASE_ANON_KEY (zat√≠m jen lok√°lnƒõ).");
      setSyncBadge({state:"warn", text:"bez supabase"});
    }else{
      setSyncBadge({state: navigator.onLine ? "warn" : "bad", text: navigator.onLine ? "ƒçek√°m na login" : "offline"});
    }

    if(!monthPick.value) monthPick.value = monthKeyDefault();
    await ensureAuthUI();

    try{
      const user = await getUser();
      if(user && navigator.onLine){
        const todayCloud = await fetchTodayEvents();
        const cache = cacheLoad().map(normalizeRow);
        const seen = new Set(cache.map(x => `${x.kind}|${x.ts}|${x.session_id||""}|${x.store_name||""}`));
        for(const r of todayCloud){
          const e = normalizeRow(r);
          const key = `${e.kind}|${e.ts}|${e.session_id||""}|${e.store_name||""}`;
          if(!seen.has(key)){
            cache.push(e);
            seen.add(key);
          }
        }
        cacheSave(cache);
      }
    }catch{}

    syncOutbox().catch(()=>{});

    render();
    setInterval(() => { updateNow(); }, 1000);
  })();

  function updateNow(){
    const d = new Date();
    elNow.textContent = `${d.getDate()}. ${d.getMonth()+1}. ${d.getFullYear()}  ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

})();
</script>
</body>
</html>
